<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="manifest" href="/manifest.json">

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../bower_components/gold-password-input/gold-password-input.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<!-- Iron pages -->
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-selector/iron-selector.html">

<!-- Firebase Query -->
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<!-- Datatable -->
<link rel="import" href="../bower_components/bwt-datatable/bwt-datatable.html">
<link rel="import" href="../bower_components/bwt-datatable/bwt-datatable-card.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="js-xlsx.html">
<link rel="import" href="shared-styles.html">

<dom-module id="company-staff">
  <template>
    <template is="dom-if" if="[[_companyid]]">
      <!-- <firebase-query id="users" path="/user" order-by-child="companyID" equal-to="[[_companyid]]"  limit-to-first="{{minData}}" data="{{usersData}}" disabled="true"> -->
      <firebase-query id="users" path="/user" order-by-child="companyID" equal-to="[[_companyid]]" data="{{usersData}}"
        disabled="true">
      </firebase-query>
    </template>

    <style include="w3-styles">
    </style>

    <style include="shared-styles">
      .card-head {
        background-color: #e9e9e9;
        min-height: 60px !important;
      }

      @media screen and (max-width: 859px) {
        .top-menu-margin {
          margin-top: 35px !important;
        }
      }

      .card-wrapper {
        min-height: 80vh !important;
      }

      .staff-name {
        font-family: Roboto, sans-serif, Helvetica, Arial, sans-serif;
        font-size: 125%;
        font-weight: 500;
        color: #313534;
        line-height: 1.846153846;
      }

      /* scss/organisms/_staff-result.scss */
      .staff-results:before,
      .staff-results:after {
        content: " ";
        display: table;
      }

      .staff-results .staff-user {
        display: inline-block;
        padding: 10px;
      }

      .hbox-xs {
        display: table;
        table-layout: fixed;
        padding: 0;
      }

      .staff-results>div {
        padding: 20px 10px;
        margin-top: -1px;
        border: 1px solid #f2f3f3;
        background: inherit;
        color: inherit;
        text-decoration: none;
      }

      .hbox-xs .hbox-column {
        display: table-cell;
      }

      .width-2,
      .size-2 {
        width: 80px;
      }

      .staff-results>div img {
        margin-right: 10px;
      }

      .hbox-xs .hbox-column {
        display: table-cell;
      }

      .v-top {
        float: none !important;
        display: table-cell;
        vertical-align: top;
      }

      .clearfix:after,
      .clearfix:before {
        content: " ";
        display: table;
      }

      .stick-top-left,
      .stick-top-right,
      .stick-top-left-right {
        position: absolute;
        top: 0;
      }

      paper-input {

        /* Reset some defaults */
        --paper-input-container: {
          padding: 0;
        }

        ;
      }
    </style>
    <style include="datatables-styles">
    </style>
    <div id="changePassword" class="ldp-modal w3-animate-zoom">
      <div class="ldp-modal-content w3-round max-modal-width">
        <div class="w3-container">
          <span id="closepassword" data="my-notifications" on-click="_closePasswordModal"
            class="w3-button w3-display-topright w3-medium w3-red w3-text-white">&times;</span>
          <div class="w3-large" style="padding:20px 15px">
            <b class="w3-text-blue w3-center">
              <iron-icon icon="app:textsms"></iron-icon>&nbsp;Change Password
            </b>
          </div>
          <div class="w3-row">
            <gold-password-input id="newpassword" name="newpassword" always-float-label label="New Password" reveal
              suffix required strength-meter minlength="6"
              error-message="The password must contain at least 6 characters"></gold-password-input>
            <gold-password-input id="confirmpassword" name="confirmpassword" always-float-label label="Confirm Password"
              reveal suffix required strength-meter minlength="6"
              error-message="The password must contain at least 6 characters"></gold-password-input>
          </div>
          <div class="w3-row w3-light-gray w3-padding w3-margin-top w3-margin-bottom">
            <div class="w3-twothird">
              <paper-button raised class="w3-blue" on-tap="changeUserPassword">
                <iron-icon icon="app:send"></iron-icon>&nbsp;CHANGE PASSWORD
              </paper-button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- Add user -->
    <div id="singleUser" class="ldp-modal w3-animate-zoom">
      <div class="ldp-modal-content w3-round max-modal-width">
        <div class="w3-container">
          <span id="closeNotifications" data="my-notifications" on-click="_closeUserModal"
            class="w3-button w3-display-topright w3-medium w3-red w3-text-white">&times;</span>
          <div class="w3-large" style="padding:20px 15px">
            <b class="w3-text-blue w3-center">
              <iron-icon icon="app:person-add"></iron-icon>&nbsp;New User
            </b>
          </div>
          <div class="w3-row">
            <paper-dropdown-menu autofocus id="dropdown_menu" label="User Category" value="{{selectedCategory}}"
              style="width: -webkit-fill-available;" tabindex="0">
              <paper-listbox id="categoryList" slot="dropdown-content" attr-for-selected="value"
                selected="{{selectedCategory}}" no-animations="true" style="min-width: 340px;">
                <paper-item value="Standard User">Standard User</paper-item>
                <paper-item value="Corporate I-Leader">Corporate I-Leader</paper-item>
                <paper-item value="Public I-Leader">Public I-Leader</paper-item>
                <paper-item value="Organisation Contributor">Organisation Contributor</paper-item>
                <template is="dom-if" if="[[_isSuperAdmin]]">
                  <paper-item value="Global Contributor">Global Contributor</paper-item>
                  <paper-item value="Company Admin">Company Admin</paper-item>
                </template>
              </paper-listbox>
            </paper-dropdown-menu>
            <paper-input id="firstName" name="firstName" always-float-label label="Firstname" type="text" required
              tabindex="1"></paper-input>
            <paper-input id="lastName" name="lastName" always-float-label label="Lastname" type="text" required
              tabindex="2"></paper-input>
            <paper-input id="email" name="email" always-float-label label="Email" type="email" required tabindex="3">
            </paper-input>
          </div>
          <div class="w3-row w3-light-gray w3-padding w3-margin-top w3-margin-bottom">
            <div class="w3-twothird">
              <paper-button raised class="w3-blue" on-tap="createNewUser">
                <iron-icon icon="app:send"></iron-icon>&nbsp;SUBMIT
              </paper-button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- upload -->
    <div id="uploadUsersModal" class="ldp-modal w3-animate-zoom">
      <div class="ldp-modal-content w3-round max-modal-width">
        <div class="w3-container">
          <span id="closeNotifications" data="my-notifications" on-click="_closeUploadModal"
            class="w3-button w3-display-topright w3-medium w3-red w3-text-white">&times;</span>
          <div class="w3-large" style="padding:20px 15px">
            <b class="w3-text-blue w3-center">
              <iron-icon icon="app:group-add"></iron-icon>&nbsp;Upload Users
            </b>
          </div>
          <div class="w3-row w3-padding">
            <form id="selectFileForm" class="w3-row w3-padding">
              <label id="pickFileLabel" class="paper-font-body2" style="cursor: pointer; margin-top: 10px;"
                for="file-uploader">
                <paper-button class="custom indigo" id="pickFile">
                  <iron-icon icon="app:attach-file"></iron-icon>&nbsp;Select File (.xlsx, .xls)
                </paper-button>
              </label>
              <br>
              <p id="filename"></p>
              <input id="file-uploader" type="file" on-change="checkfile" />
              <div class="upload-buttons w3-light-gray">
                <div id="hideRemoveFile" hidden class="w3-row w3-padding">
                  <paper-button class="w3-blue" raised on-tap="uploadNewUsers">Upload File</paper-button>
                  <paper-button class="w3-blue" raised on-tap="removeFile">Remove File</paper-button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <!-- user type -->
    <div id="user-type" class="ldp-modal w3-animate-zoom">
      <div class="ldp-modal-content w3-round max-modal-width">
        <div class="w3-container w3-padding-large">
          <span id="closeUserType" data="user-type" on-click="_closeUserTypeModal"
            class="w3-button w3-display-topright w3-medium w3-red w3-text-white">&times;</span>
          <div class="w3-large w3-border-bottom" style="padding:20px 15px">
            <b class="w3-text-dark-gray w3-center">
              <iron-icon icon="app:create"></iron-icon>&nbsp;Change Type
            </b>
          </div>
          <div class="w3-row w3-margin">
            <paper-dropdown-menu autofocus id="dropdown_menu" label="User Category" value="{{selectedType}}"
              style="width: -webkit-fill-available;" tabindex="0" horizontal-align="right">
              <paper-listbox id="typeList" slot="dropdown-content" attr-for-selected="value" selected="{{selectedType}}"
                no-animations="true" style="min-width: 340px;">
                <paper-item value="Standard User">Standard User</paper-item>
                <paper-item value="Corporate I-Leader">Corporate I-Leader</paper-item>
                <paper-item value="Public I-Leader">Public I-Leader</paper-item>
                <paper-item value="Organisation Contributor">Organisation Contributor</paper-item>
                <template is="dom-if" if="[[_isSuperAdmin]]">
                  <paper-item value="Global Contributor">Global Contributor</paper-item>
                  <paper-item value="Company Admin">Company Admin</paper-item>
                </template>

              </paper-listbox>
            </paper-dropdown-menu>
          </div>
          <div class="w3-row w3-light-grey w3-padding">
            <paper-button raised class="w3-blue" on-tap="updateUserType">
              <iron-icon icon="app:send"></iron-icon>&nbsp;SUBMIT
            </paper-button>
          </div>
        </div>
      </div>
    </div>
    <section>
      <div class="w3-row w3-center top-menu-margin">
        <paper-spinner hidden="{{!isloading}}" class="w3-center" active="{{isloading}}"
          style="height: 50px; width: 50px; margin:auto"></paper-spinner>
      </div>
      <div class="card-wrapper w3-row w3-card w3-white">
        <div class="card-head">
          <div class="card-head w3-mobile">
            <div class="w3-padding-small w3-left">
              <paper-button raised class="w3-blue w3-margin-bottom w3-padding-small" on-tap="newUserDialog">
                <iron-icon icon="app:person-add"></iron-icon>&nbsp;Add User
              </paper-button>
              <paper-button raised class="w3-blue w3-padding-small" on-tap="uploadUsersDialog">
                <iron-icon icon="app:group-add"></iron-icon>&nbsp;Upload Users (XLS)
              </paper-button>
            </div>
          </div>
        </div>

        <div class="card-body w3-row">
          <paper-datatable-card id="datatableCard" header="Company Employees" data-source$="{{dataSource}}" progress
            id-property="firstName" selected-ids="{{selectedIds}}" header-fixed>
            <div slot="toolbar-main">
              <paper-input value="{{searchTerm}}" on-input="_handleSearchStaff" label="Search..."
                style="display:inline-block" no-label-float>
                <div prefix>
                  <iron-icon icon="search"></iron-icon>
                </div>
              </paper-input>
              <paper-icon-button icon="cached" on-tap="retrieveResults"></paper-icon-button>
            </div>
            <div class="w3-mobile" slot="toolbar-select">
              <paper-button raised class="w3-green w3-tiny" on-tap="_openUserTypeModal">
                <iron-icon icon="myicons:create"></iron-icon>&nbsp;Change UserType
              </paper-button>
            </div>
            <template is="dom-if" if="[[_isSuperAdmin]]">
              <div class="w3-mobile" slot="toolbar-select">
                <paper-button raised class="w3-blue w3-tiny" on-tap="_resendWelcomeMail">
                  <iron-icon icon="myicons:markunread-mailbox"></iron-icon>&nbsp;Resend Welcome Mail
                </paper-button>
              </div>
              <div class="w3-mobile" slot="toolbar-select">
                <paper-button raised class="w3-blue w3-tiny" on-tap="_changePasswordDialog">
                  <iron-icon icon="app:textsms"></iron-icon>&nbsp;Change Password
                </paper-button>
              </div>
            </template>
            <div class="w3-mobile" slot="toolbar-select">
              <paper-button raised class="w3-deep-orange w3-tiny w3-text-white" on-tap="disableAccount">
                <iron-icon icon="app:check"></iron-icon>&nbsp;Activate / Deactivate
              </paper-button>
            </div>
            <div class="w3-mobile" slot="toolbar-select">
              <paper-button raised class="w3-red w3-tiny" on-tap="deleteAccount">
                <iron-icon icon="myicons:delete"></iron-icon>&nbsp;Delete
              </paper-button>
            </div>
            <paper-datatable id="datatable" selectable header-fixed selected-item="{{selectedItem}}"
              selected-key="{{selectedKey}}">
              <paper-datatable-column id="profileImageColumn" header="" type="Object" property=""
                style="min-width: 50px;">
                <template>
                  <div>
                    <img src="[[_profilePhoto(item.photoURL)]]"
                      style="width:36px;height:36px;border-radius:16px;vertical-align: middle;margin-right:4px;">
                  </div>
                </template>
              </paper-datatable-column>
              <paper-datatable-column id="firstNameColumn" header="Firstname" type="Object" sortable
                property="firstName" style="min-width: 50px;" sorted>
                <template>
                  <div>
                    <span style="vertical-align:middle;">[[item.firstName]]</span>
                  </div>
                </template>
              </paper-datatable-column>
              <paper-datatable-column id="lastNameColumn" header="Lastname" property="lastName" sortable>
              </paper-datatable-column>
              <paper-datatable-column header="E-mail" property="email" style="min-width: 200px;" sortable>
              </paper-datatable-column>
              </paper-datatable-column>
              <paper-datatable-column header="User Type" type="Object" property="userType" sortable>
                <template>
                  <span>[[_getUserTypeDesc(item.userType)]]</span>
                </template>
              </paper-datatable-column>
              <paper-datatable-column class="w3-text-color" id="userStatusColumn" header="Status" type="Object"
                property="" style="min-width: 30px;">
                <template>
                  <div>
                    <iron-icon style$="[[_isDisabled(item.disabled)]]" icon="myicons:radio-button-checked"></iron-icon>
                  </div>
                </template>
              </paper-datatable-column>
            </paper-datatable>
          </paper-datatable-card>
        </div>
      </div>
      </div>
      <paper-toast id="toaster"></paper-toast>
    </section>

  </template>
  <script>

    var _ua = window.navigator.userAgent;
    var scrollTopPosition
    iOS = /iPad|iPhone|iPod/.test(_ua),
      iOS11 = /OS 11_0|OS 11_1|OS 11_2|OS 11_3/.test(_ua);

    class CompanyStaff extends Polymer.Element {
      static get is() {
        return 'company-staff';
      }
      ready() {
        super.ready();

        var that = this;
        Polymer.RenderStatus.afterNextRender(this, () => {
          if ((this._companyid == "-KgsUcgfo7z1U9MXgd9i") || (this._companyid == "-LDVbbRyIMhukVtTVQ0n")) {
            this._isSuperAdmin = true;
          }

          Polymer.dom(this.root).querySelector('#users').disabled = false;
        });
      }
      static get properties() {
        return {
          user: {
            type: Object,
            observer: "userReceived"
          },
          uid: String,
          nextpage: {
            type: String,
            value: "users-list",
            notify: true
          },
          _companyid: String,
          isloading: {
            type: Boolean,
            value: true
          },
          minData: {
            type: Number,
            value: 50
          },
          usersData: {
            type: Object,
            observer: '_onusersDataDataReceived'
          },
          loadmore: {
            type: Boolean,
            value: true
          },
          _isSuperAdmin: {
            type: Boolean,
            value: false
          },
          edituserid: {
            type: String,
            value: ""
          }
        };
      }
      userReceived() {
        if (this.user) {
          this.uid = this.user.uid;
          let database = firebase.database();
          // clear previous search results
          database.ref(`/searchResults/users/${this.uid}`).remove();
        }
      }
      _initDatatable() {

        var app = this.$.datatableCard;
        var that = this;
        app.dataSource = {
          get: function (sort, page, pageSize) {

            return new Promise(function (resolve, reject) {
              var count = 0;
              var staffData = [];
              staffData = that._toArray(that.usersData)

              staffData.sort(function (a, b) {
                if (sort.direction == 'desc') {
                  var c = a;
                  a = b;
                  b = c;
                }

                a = a[sort.property];
                b = b[sort.property];

                a = typeof a === 'string' ? a.toLowerCase().trim() : a;
                b = typeof b === 'string' ? b.toLowerCase().trim() : b;

                if (a > b) return 1;
                if (a < b) return -1;
                return 0;
              });

              var startAt = Number((page - 1) * pageSize);
              var endAt = Number((pageSize * page) - 1);
              var clonedData = staffData.slice(startAt, endAt);

              app.set('dataSource.length', staffData.length);

              resolve(clonedData);
            });
          },
          // none of the <templates> bind in an editable way right now, but if they would this is the function
          // that's triggered after an edit
          set: function (id, property, value) {
            console.info("a save was triggered", arguments);
          },
          length: 0
        };
      }
      _toArray(obj) {
        var that = this;
        if (obj != undefined) {
          return Object.keys(obj).map(function (key) {
            // if(key < pageSize){
            obj[key].id = obj[key]['$key'];
            obj[key].uid = obj[key]['$key'];
            // obj[key].id = Number(key);
            // delete obj[key]['$key'];
            return obj[key];
            // }
          });
        }
      }
      _handleSearchStaff() {
        var app = this.$.datatableCard;

        var that = this;
        app.dataSource = {
          get: function (sort, page, pageSize) {

            return new Promise(function (resolve, reject) {
              var count = 0;
              var searchedUsers = [];
              var staffData = [];
              staffData = that._toArray(that.usersData)

              searchedUsers = staffData.filter(function (user) {
                if (user.firstName != undefined) {
                  if (user.firstName.toLowerCase().indexOf(that.searchTerm.toLowerCase()) > -1) return true;
                }
                if (user.lastName != undefined) {
                  if (user.lastName.toLowerCase().indexOf(that.searchTerm.toLowerCase()) > -1) return true;
                }
                if (user.email != undefined) {
                  if (user.email.toLowerCase().indexOf(that.searchTerm.toLowerCase()) > -1) return true;
                }
              });

              searchedUsers.sort(function (a, b) {
                if (sort.direction == 'desc') {
                  var c = a;
                  a = b;
                  b = c;
                }

                a = a[sort.property];
                b = b[sort.property];

                a = typeof a === 'string' ? a.toLowerCase().trim() : a;
                b = typeof b === 'string' ? b.toLowerCase().trim() : b;

                if (a > b) return 1;
                if (a < b) return -1;
                return 0;
              });

              app.set('dataSource.length', searchedUsers.length);

              var startAt = Number((page - 1) * pageSize);
              var endAt = Number((pageSize * page) - 1);
              var clonedData = searchedUsers.slice(startAt, endAt);

              resolve(clonedData);
            });
          },
          // none of the <templates> bind in an editable way right now, but if they would this is the function
          // that's triggered after an edit
          set: function (id, property, value) {
            // console.info("a save was triggered", arguments);
          },
          length: 0
        };
      }
      _getUserTypeDesc(type) {
        var userTypes = {
          4: "Global Contributor",
          5: "Master Contributor",
          7: "Company Admin",
          8: "Standard User",
          10: "Corporate I-Leader",
          3: "Public I-Leader",
          11: "Organisation Contributor",
        }

        var typedesc = userTypes[type];

        return typedesc ? typedesc : "Standard User";
      }
      _getUserType(type) {
        var userTypes = {
          "Global Contributor": 4,
          "Master Contributor": 5,
          "Company Admin": 7,
          "Standard User": 8,
          "Corporate I-Leader": 10,
          "Public I-Leader": 3,
          "Organisation Contributor": 11
        }

        var typedesc = userTypes[type];

        return typedesc ? typedesc : 8;
      }

      _onusersDataDataReceived(newData, oldData) {
        var that = this;

        if (newData.length > 0) {
          // Initialize dataTable
          that._initDatatable();
          this.isloading = false;
        }

        setTimeout(function () {
          that.isloading = false;
        }, 20000);

      }
      retrieveResults() {
        this.$.datatableCard.deselectAll();
        this.$.datatable.reload();
        this.$.datatableCard.retrieveVisibleData();

        // this._initDatatable();
      };
      disableAccount() {
        var that = this;
        const userProfile = this.selectedItem;

        let userID = this.selectedItem.userID;
        let userName = this.selectedItem.firstName + " " + this.selectedItem.lastName;
        let active = this.selectedItem.disabled;

        let disabled = true;
        let disabledText = 'Deactivate';

        var currUserID = this.user.userID;
        if (currUserID == userProfile.userID) {
          Polymer.dom(that.root).querySelector('#toaster').show({
            text: "Cannot deactivate your own account!"
          });
          return;
        }

        active ? disabled = false : true;
        disabled ? disabledText = 'Deactivate' : disabledText = 'Activate';
        if (confirm(disabledText + ' selected account: ' + userName + '?')) {
          // Get a reference to the database service
          let database = firebase.database();
          // Update user data 
          let updates = {};
          updates['/users/' + userID + '/disabled'] = disabled;
          updates['/user/' + userProfile.uid + '/disabled'] = disabled;
          updates['writeOperations/disableUserElastic/' + userProfile.uid + '/writeOperationsID'] = userProfile.uid;
          updates['writeOperations/disableUserElastic/' + userProfile.uid + '/uid'] = userProfile.uid;

          database.ref().update(updates).then(() => {
            that.retrieveResults();
            Polymer.dom(that.root).querySelector('#toaster').show({
              text: `User Account ${disabledText}!`
            });
          }).catch(() => {
            Polymer.dom(that.root).querySelector('#toaster').show({
              text: `Error ${disabledText} user account!`
            });
          });

        }
      }
      updateUserType() {
        let database = firebase.database();

        var that = this;
        const userProfile = this.selectedItem;
        // const userProfile = this.usersData.find((value) => value.userID === that.edituserid ? value : null);
        var selected = this.selectedType;
        var uid = userProfile.uid;
        var userID = userProfile.userID;
        var companyID = userProfile.companyID;
        var userType = this._getUserType(selected);

        var currUserType = this.user.userType;
        var currUserID = this.user.userID;

        if (currUserID == userID) {
          if ((currUserType == 7) && (userType != 7)) {
            Polymer.dom(that.root).querySelector('#toaster').show({
              text: "Could not remove Admin Role from your own account!"
            });
            return
          }
        }

        // Update user data 
        let updates = {};
        updates['/users/' + userID + '/companyID_userType'] = companyID + "_" + userType;
        updates['/users/' + userID + '/userType'] = userType;
        updates['/users/' + userID + '/userDescription'] = selected;
        updates['/user/' + uid + '/companyID_userType'] = companyID + "_" + userType;
        updates['/user/' + uid + '/userType'] = userType;
        updates['/user/' + uid + '/userDescription'] = selected;

        // updates['writeOperations/updateUserElastic/'+uid+'/writeOperationsID'] = uid;
        // updates['writeOperations/updateUserElastic/'+uid+'/uid'] = uid;

        this._closeUserTypeModal();
        database.ref().update(updates).then(() => {
          that.retrieveResults();
          Polymer.dom(that.root).querySelector('#toaster').show({
            text: "User updated successfully."
          });
        }).catch(() => {
          Polymer.dom(that.root).querySelector('#toaster').show({
            text: "Error updating user details."
          });
        });

      }
      _resendWelcomeMail() {
        var database = firebase.database();
        var data = this.selectedItem;

        delete data['$key'];

        database.ref('/resend-welcomemail/' + data.uid).set(data);

        Polymer.dom(this.root).querySelector('#toaster').show({
          text: "Resent successfully!"
        });
      }
      changeUserPassword() {
        var database = firebase.database();
        var data = this.selectedItem;
        delete data['$key'];

        var newpassword = this.$.newpassword.value;
        var confirmpassword = this.$.confirmpassword.value;

        var newpasswordVal = this.$.newpassword.validate();
        var confirmpasswordVal = this.$.confirmpassword.validate();

        if (!newpasswordVal) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Password is required!"
          });
          return;
        }

        if (!confirmpasswordVal) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Confirm Password is required!"
          });
          return;
        }

        if (newpassword !== confirmpassword) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Password and Confirm Password are not matching!"
          });
          return;
        }

        data.password = newpassword;

        database.ref('/reset-password/' + data.uid).set(data);

        Polymer.dom(this.root).querySelector('#toaster').show({
          text: "Password reset successfully!"
        });

        this._closePasswordModal();
      }
      _openUserTypeModal() {
        // this.edituserid = e.currentTarget.data;
        var that = this;
        const userProfile = this.selectedItem;
        // const userProfile = this.usersData.find((value) => value.userID === that.edituserid ? value : null);
        this.selectedType = this._getUserTypeDesc(userProfile.userType);

        // ios 11 bug caret position
        if (iOS && iOS11) {
          this.addIOSBugfix();
        }
        var modal = Polymer.dom(this.root).querySelector('#user-type');
        modal.style.display = 'block';
      }

      _closeUserTypeModal() {
        // ios 11 bug caret position
        if (iOS && iOS11) {
          this.removeIOSBugfix();
        }

        var modal = Polymer.dom(this.root).querySelector('#user-type');
        modal.style.display = 'none';
      }

      findObjectByKey(array, key, value) {
        for (var i = 0; i < array.length; i++) {
          if (array[i][key] === value) {
            return array[i];
          }
        }
        return null;
      }


      findAndDeleteDocument(documentPathUrl, objectId) {
        // Get a reference to the database service
        const database = firebase.database();
        database.ref(`${documentPathUrl}/${objectId}`).remove();

      }

      // Delete User account from DB
      async deleteAccount(e) {

        try {
          //Get user data from targeted event
          const {
            data,
            username
          } = e.target;

          const userProfile = this.selectedItem

          var currUserID = this.user.userID;

          if (currUserID == userProfile.userID) {
            Polymer.dom(this.root).querySelector('#toaster').show({
              text: "Cannot delete your own account!"
            });
            return
          }

          //TODO: User Paper Dialog to Confirmation with (Yes) / (No) buttons 
          //Confirm user deletion action 

          const answerEmail = prompt(
            `Are your sure you want to remove ${userProfile.firstName} ${userProfile.lastName} \n ( Please type in the email of the User !) `
          );

          if (answerEmail === '' || answerEmail === null || answerEmail !== userProfile.email) {
            Polymer.dom(this.root).querySelector('#toaster').show({
              text: "User not deleted: Incorrect email address provided."
            });
            return;
          }

          // Remove user object from subscribed, users, user , if any 
          this.findAndDeleteDocument('subscribed', userProfile.userID);
          this.findAndDeleteDocument('users', userProfile.userID);
          this.findAndDeleteDocument('user', userProfile.uid);

          Polymer.dom(this.root).querySelector('#toaster').show({
            text: `Deleted ${userProfile.firstName} ${userProfile.lastName} successfully!`
          });
          this.retrieveResults();
        } catch (error) {

          console.log(error);

        } // end try-catch block

      } // end deleteAccount func

      _isDisabled(disabled) {
        return disabled ? "color:red" : "color:green";
      }
      uploadUsersDialog() {
        var modal = Polymer.dom(this.root).querySelector('#uploadUsersModal');
        modal.style.display = "block";
      }
      _changePasswordDialog() {
        var modal = Polymer.dom(this.root).querySelector('#changePassword');
        modal.style.display = "block";
      }
      checkfile(e) {
        var validExts = new Array(".xlsx", ".xls");
        var fileName = e.target.files[0].name;

        var fileExt = fileName.substring(fileName.lastIndexOf('.'));

        if (validExts.indexOf(fileExt) < 0) {
          this.$.hideRemoveFile.style = "display: none";
          this.$.filename.innerHTML = fileName;

          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Invalid file selected, valid files are of " +
              validExts.toString() + " types."
          });
          this.removeFile();
          return false;
        } else {
          this.$.hideRemoveFile.style = "display: block";
          this.$.filename.innerHTML = fileName;

          return true;
        }
      }
      removeFile() {
        var pickFileLabel = this.$.pickFileLabel;
        this.$.hideRemoveFile.style = "display: none";
        this.$.filename.innerHTML = "";
        pickFileLabel.style = "display: block;";
        var selectFileForm = Polymer.dom(this.root).querySelector('#selectFileForm');
        selectFileForm.reset();
      }

      isEqual(a, b) {
        return a === b;
      }
      newUserDialog() {
        // ios 11 bug caret position
        if (iOS && iOS11) {
          this.addIOSBugfix();
        }
        var modal = Polymer.dom(this.root).querySelector('#singleUser');
        modal.style.display = "block";
      }
      createNewUser() {
        var email = this.$.email.value;
        var firstName = this.$.firstName.value;
        var lastName = this.$.lastName.value;

        var emailVal = this.$.email.validate();
        var firstNameVal = this.$.firstName.validate();
        var lastNameVal = this.$.lastName.validate();

        let companyID = this.user.companyID;
        let companyName = this.user.companyName;

        // Validate thought category
        if ((this.selectedCategory == undefined) || (this.selectedCategory == -1)) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Please select user category!"
          });
          return;
        }

        let userDescription = "Standard User";
        let userType = 8;

        if (this.selectedCategory == "Global Contributor") {
          userDescription = this.selectedCategory;
          userType = 4;
        } else if (this.selectedCategory == "Master Contributor") {
          userDescription = this.selectedCategory;
          userType = 5;
        } else if (this.selectedCategory == "Company Admin") {
          userDescription = this.selectedCategory;
          userType = 7;
        } else if (this.selectedCategory == "Standard User") {
          userDescription = this.selectedCategory;
          userType = 8;
        } else if (this.selectedCategory == "Corporate I-Leader") {
          userDescription = this.selectedCategory;
          userType = 10;
        } else if (this.selectedCategory == "Public I-Leader") {
          userDescription = this.selectedCategory;
          userType = 3;
        } else if (this.selectedCategory == "Organisation Contributor") {
          userDescription = this.selectedCategory;
          userType = 11;
        }

        // get date and time
        var timeInMs = Date.now();
        var datetime = new Date(timeInMs);
        // format date
        datetime = this.formatDate(datetime);

        // Get a reference to the database service
        var database = firebase.database();

        if (!email || !emailVal) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Email is required!"
          });
          return;
        } else if (!firstName || !firstNameVal) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Firstname is required!"
          });
          return;
        } else if (!lastName || !lastNameVal) {
          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "Lastname is required!"
          });
          return;
        } else {
          var userID = database.ref().child('newUploadUsers').push().key;
          var defPassword = Math.random().toString(36).substring(2, 6) + Math.random().toString(36).substring(2, 6);
          defPassword = defPassword.toUpperCase();

          var data = {
            "companyID": companyID,
            "companyName": companyName,
            "dateRegistered": timeInMs,
            "email": email,
            "firstName": firstName,
            "lastName": lastName,
            "password": defPassword,
            "stringDateRegistered": datetime,
            "userDescription": userDescription,
            "newUploadUserID": userID,
            "userType": userType,
            "companyID_userType": companyID + "_" + userType
          }
          // ,
          //   "ce_id": "Qw3agl7y8IVbRYfnBxf2PBthfRu1",
          //   "ceo_id": "WXiLeBhQwqT6YpVEyBuRI28nIG82"

          // Write the new rating data
          var updates = {};
          updates['/newUploadUsers/' + userID] = data;
          database.ref().update(updates);

          this.$.email.value = "";
          this.$.firstName.value = "";
          this.$.lastName.value = "";
          this.selectedCategory = "";

          Polymer.dom(this.root).querySelector('#toaster').show({
            text: "User created successfully!"
          });

          var modal = Polymer.dom(this.root).querySelector('#singleUser');
          modal.style.display = 'none';
        }
      }
      uploadNewUsers() {
        var files = Polymer.dom(this.root).querySelector('#file-uploader').files;
        var i, f;

        let companyID = this.user.companyID;
        let companyName = this.user.companyName;
        // get date and time
        var timeInMs = Date.now();
        var datetime = new Date(timeInMs);
        // format date
        datetime = this.formatDate(datetime);

        // Get a reference to the database service
        var database = firebase.database();

        for (i = 0, f = files[i]; i != files.length; ++i) {
          var reader = new FileReader();
          var name = f.name;
          reader.onload = function (e) {

            var data = e.target.result;
            var workbook = XLSX.read(data, {
              type: 'binary'
            });

            function to_json(workbook) {
              var result = {};
              workbook.SheetNames.forEach(function (sheetName) {
                var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                if (roa.length > 0) {
                  result[sheetName] = roa;
                }
              });
              return result;
            }

            var xls_json = to_json(workbook);
            var users;
            // console.log('xls json: '+JSON.stringify(xls_json));
            Object.keys(xls_json).forEach(key => {
              users = xls_json[key];
              users.forEach((userobj, index) => {
                var email = userobj.Email;
                if (email !== undefined && email.length > 5) {
                  var userID = database.ref().child('newUploadUsers').push().key;
                  var defPassword = Math.random().toString(36).substring(2, 6) + Math.random().toString(
                    36).substring(2, 6);
                  defPassword = defPassword.toUpperCase();

                  var data = {
                    "companyID": companyID,
                    "companyName": companyName,
                    "dateRegistered": timeInMs,
                    "email": userobj.Email,
                    "firstName": userobj.Firstname,
                    "lastName": userobj.Lastname,
                    "password": defPassword,
                    "stringDateRegistered": datetime,
                    "userDescription": "Standard User",
                    "newUploadUserID": userID,
                    "userType": 8,
                    "companyID_userType": companyID + "_8"
                  }
                  // ,"ce_id": "Qw3agl7y8IVbRYfnBxf2PBthfRu1",
                  // "ceo_id": "WXiLeBhQwqT6YpVEyBuRI28nIG82"

                  // Write the new rating data
                  var updates = {};
                  updates['/newUploadUsers/' + userID] = data;
                  database.ref().update(updates);
                }

              });
            });

            /* DO SOMETHING WITH workbook HERE */
          };
          reader.readAsBinaryString(f);
        }

        Polymer.dom(this.root).querySelector('#toaster').show({
          text: "Users uploaded successfully!"
        });

        var modal = Polymer.dom(this.root).querySelector('#uploadUsersModal');
        modal.style.display = 'none';
      }
      _closeUploadModal() {
        var modal = Polymer.dom(this.root).querySelector('#uploadUsersModal');
        modal.style.display = 'none';
      }
      _closePasswordModal() {
        var modal = Polymer.dom(this.root).querySelector('#changePassword');
        modal.style.display = 'none';
      }
      _closeUserModal() {
        var modal = Polymer.dom(this.root).querySelector('#singleUser');
        modal.style.display = 'none';
      }
      formatDate(date) {
        var d = new Date(date),
          month = '' + (d.getMonth() + 1),
          day = '' + d.getDate(),
          year = d.getFullYear(),
          hours = '' + d.getHours(),
          minutes = '' + d.getMinutes(),
          seconds = '' + d.getSeconds(),
          milliseconds = '' + d.getMilliseconds();

        var today = new Date(),
          thisYear = today.getFullYear();

        // get week day name Sunday - Saturday
        var dayName = this.getDayMonthStr(d.getDay(), "day", true);

        // get month name
        var monthName = this.getDayMonthStr(d.getMonth(), "month", true);

        // add preceding zeros where needed
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        if (hours.length < 2) hours = '0' + hours;
        if (minutes.length < 2) minutes = '0' + minutes;
        if (seconds.length < 2) seconds = '0' + seconds;
        if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

        // format thoughts date
        // Monday, 04 December 2017 14:21:56
        var thoughtDate = dayName + ", " + day + " " + monthName + " " + year + " " + hours + ":" + minutes + ":" +
          seconds;

        return thoughtDate;
        // return [year, month, day].join('-');
      }
      getDayMonthStr(val, dateParam, long) {
        // days
        var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        var daysShort = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];

        // Months
        var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September",
          "October", "November", "December"
        ];
        var monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        if (dateParam == "day" && long == true) {
          // return day in long format
          return days[val];
        } else if (dateParam == "day" && long == false) {
          // return days in short
          return daysShort[val];
        }
        if (dateParam == "month" && long == true) {
          // return month in long format
          return monthNames[val];
        } else if (dateParam == "month" && long == false) {
          // return month in short
          return monthNamesShort[val];
        }

      }


      _profilePhoto(photo) {
        let photo_url = "../images/default-user.png";

        if (photo == undefined) {
          photo_url = "../images/default-user.png";
        } else if (photo == "") {
          photo_url = "../images/default-user.png";
        } else {
          photo_url = "" + photo;
        }

        return photo_url;
      }

      addIOSBugfix() {
        // Get scroll position before moving top
        scrollTopPosition = $(document).scrollTop();
        // Add CSS to body "position: fixed"
        $("body").addClass("iosBugFixCaret");
        // $("body").css('position: fixed!important; width: 100%!important;');
      }
      removeIOSBugfix() {
        // Remove CSS to body "position: fixed"
        $("body").removeClass("iosBugFixCaret");

        //Go back to initial position in document
        $(document).scrollTop(scrollTopPosition);
      }
    }

    window.customElements.define(CompanyStaff.is, CompanyStaff);
  </script>

</dom-module>