<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="manifest" href="/manifest.json">

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">

<link rel="import" href="../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<!-- Ensure Web Animations polyfill is loaded since neon-animation 2.0 doesn't import it -->
<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">

<!-- Firebase Query -->
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="js-xlsx.html">
<link rel="import" href="shared-styles.html">

<dom-module id="company-staff">
  <template>
    <template is="dom-if" if="[[_companyid]]">
      <firebase-query id="users" path="/users" order-by-child="companyID" equal-to="[[_companyid]]" limit-to-first="{{minData}}"
        data="{{usersData}}" disabled="true">
      </firebase-query>
      <!-- order-by-child="companyID"
          equal-to="[[_companyid]]" -->
    </template>

    <style include="w3-styles">
      .w3-modal{
      padding-top: 200px!important;
    }
    .w3-modal-content{
      right: 10px;
      position: fixed;
      min-width: 320px;
      max-width: 600px!important;
    }
  </style>

    <style include="shared-styles">
      :host{
      --paper-icon-button-hover: {
        color: red;
      }
    }
    .content {
      display: block;
      position: relative;
      max-width: 1000px;
      border: 1px solid #eaeaea;
    }
    
    
    @media (max-width: 960px) {
      .content {
        max-width: 800px;
      }
    }
    @media (max-width: 719px) {
      .content {
        max-width: 400px;
      }
    }
    iron-list {
      margin-left: 16px;
      margin-right: 16px;
      z-index: 1;
      --iron-list-items-container: {
        max-width: 100%;
        margin: auto;
        margin-top: 14px;
        margin-bottom: 60px;
        border-bottom: 1px solid #ddd;
      };
    }
    .item {
      @apply --layout-horizontal;
      padding: 20px;
      background-color: white;
      border: 1px solid #ddd;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .avatar {
      height: 40px;
      width: 40px;
      border-radius: 20px;
      box-sizing: border-box;
      background-color: #DDD;
    }
    .pad {
      padding: 0 16px;
      @apply --layout-flex;
      @apply --layout-vertical;
    }
    .primary {
      font-size: 16px;
      font-weight: bold;
    }
    .shortText, .longText {
      font-size: 14px;
    }
    .longText {
      color: gray;
      display: none;
    }
   
    .modal-header {
        padding: 2px 16px;
    }
    .modal-body {padding: 2px 16px;}
    .modal-footer {
        padding: 2px 16px;
        color: white;
    }
    /* Add Animation */
    @-webkit-keyframes slideIn {
        from {bottom: -300px; opacity: 0} 
        to {bottom: 0; opacity: 1}
    }
    @keyframes slideIn {
        from {bottom: -300px; opacity: 0}
        to {bottom: 0; opacity: 1}
    }
    @-webkit-keyframes fadeIn {
        from {opacity: 0} 
        to {opacity: 1}
    }
    @keyframes fadeIn {
        from {opacity: 0} 
        to {opacity: 1}
    }
    .thought-prevImg{
      display: flex;
      height: 260px;
      /* width: 100%; */
      border-radius: 1px;
      text-align: center;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-bottom: 1px;
      padding: 16px;
    }
    /* end dialog css */

    @-webkit-keyframes fadeInUp{
        0%{opacity:0;-webkit-transform:translateY(20px);transform:translateY(20px)}
        100%{opacity:1;-webkit-transform:translateY(0);transform:translateY(0)}
    }
    @keyframes fadeInUp{
        0%{opacity:0;-webkit-transform:translateY(20px);-ms-transform:translateY(20px);transform:translateY(20px)}
        100%{opacity:1;-webkit-transform:translateY(0);-ms-transform:translateY(0);transform:translateY(0)}
    }
    .fadeInUp{
        -webkit-animation-name:fadeInUp;
        animation-name:fadeInUp;
        opacity: 0;
        -webkit-animation-duration: 0.5s;
        animation-duration: 0.5s;
        -webkit-animation-fill-mode: forwards;
        animation-fill-mode: forwards;
        animation-timing-function: ease-in;
    }
    .add-users-bar{
      display: -webkit-flex;
      display: flex;
      flex-direction: row;
      padding: 16px;
      border: 1px solid #eaeaea;
      margin-top: 16px;
      align-items: center;
      justify-content: flex-end;
    }
    .upload-buttons{
      margin-top: 16px; 
      width:100%;
      display: flex;
      display: -webkit-flex;
      flex-direction: row;
      align-items: flex-start;
      justify-content: flex-start;
    }
    #selectFileForm{
      width: 100%;
      max-width: 340px;
      padding: 16px;
      text-align: left;
      border: 1px solid #eaeaea;
      border-radius: 2px;
      padding: 16px;
    }
  </style>



    <!-- The Modal -->
    <div id="myModal" class="w3-modal">
      <!-- Modal content -->
      <div class="w3-modal-content w3-animate-right w3-card-2">
        <div class="modal-header w3-theme-l1">
          <span id="closeModal" class="w3-button w3-display-topright w3-red w3-text-white">&times;</span>
          <h2 class="w3-text-white">
            <iron-icon icon="app:group-add"></iron-icon>&nbsp;Upload Users
          </h2>
        </div>
        <div class="modal-body">
        </div>
        <div class="thought-prevImg" id="thoughtImg">
          <form id="selectFileForm">
            <label id="pickFileLabel" class="paper-font-body2" style="cursor: pointer; margin-top: 10px;" for="file-uploader">
              <paper-button class="custom indigo" id="pickFile">
                <iron-icon icon="app:attach-file"></iron-icon>&nbsp;Select File (.xlsx, .xls)
              </paper-button>
            </label>
            <br>
            <p id="filename"></p>
            <input id="file-uploader" type="file" on-change="checkfile" />
            <div class="upload-buttons">
              <div id="hideRemoveFile" hidden>
                <paper-button class="custom" style="color:#eaeaea; background:#810029; margin-right: 6px;" raised
                  on-tap="uploadNewUsers">Upload File</paper-button>
                <paper-button class="custom" style="color:#810029; background:#eaeaea;" raised on-tap="removeFile">Remove
                  File</paper-button>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer w3-theme-l1">
        </div>
      </div>
    </div>

    <!-- The Modal -->
    <div id="singleUser" class="w3-modal">
      <div class="w3-modal-content w3-animate-right w3-card-4">
        <header class="w3-container w3-theme-l1">
          <span id="closeSingleUser" class="w3-button w3-display-topright w3-red w3-text-white">&times;</span>
          <h2 class="w3-text-white">
            <iron-icon icon="app:person-add"></iron-icon>&nbsp;New User
          </h2>
        </header>
        <div class="w3-container">
          <paper-dropdown-menu autofocus id="dropdown_menu" label="User Category" value="{{selectedCategory}}" style="width: -webkit-fill-available;"
            tabindex="0">
            <paper-listbox id="categoryList" slot="dropdown-content" attr-for-selected="value" selected="{{selectedCategory}}"
              no-animations="true" style="min-width: 340px;">
              <paper-item value="Standard User">Standard User</paper-item>
              <template is="dom-if" if="[[_isSuperAdmin]]">
                <paper-item value="Global Contributor">Global Contributor</paper-item>
                <paper-item value="Company Admin">Company Admin</paper-item>
              </template>
            </paper-listbox>
          </paper-dropdown-menu>
          <paper-input id="firstName" name="firstName" always-float-label label="Firstname" type="text" required
            tabindex="1"></paper-input>
          <paper-input id="lastName" name="lastName" always-float-label label="Lastname" type="text" required tabindex="2"></paper-input>
          <paper-input id="email" name="email" always-float-label label="Email" type="email" required tabindex="3"></paper-input>
        </div>
        <footer class="w3-container w3-light-grey w3-padding">
          <paper-button raised class="w3-blue" on-tap="createNewUser">
            <iron-icon icon="app:send"></iron-icon>&nbsp;SUBMIT
          </paper-button>
        </footer>
      </div>
    </div>

    <div id="user-type" class="ldp-modal w3-animate-zoom">
			<div class="ldp-modal-content w3-round max-modal-width">
				<div class="w3-container w3-padding-large">
					<span id="closeUserType" data="user-type" on-click="_closeUserTypeModal" class="w3-button w3-display-topright w3-medium w3-red w3-text-white">&times;</span>
					<div class="w3-large w3-border-bottom" style="padding:20px 15px">
						<b class="w3-text-dark-gray w3-center"><iron-icon icon="app:create"></iron-icon>&nbsp;Change Type</b>
          </div>
          <div class="w3-row w3-margin">
            <paper-dropdown-menu autofocus id="dropdown_menu" label="User Category" value="{{selectedType}}" style="width: -webkit-fill-available;"
            tabindex="0" horizontal-align="right">
              <paper-listbox id="typeList" slot="dropdown-content" attr-for-selected="value" selected="{{selectedType}}"
                no-animations="true" style="min-width: 340px;">
                <paper-item value="Standard User">Standard User</paper-item>
                <template is="dom-if" if="[[_isSuperAdmin]]">
                  <paper-item value="Global Contributor">Global Contributor</paper-item>
                  <paper-item value="Company Admin">Company Admin</paper-item>
                </template>
                
              </paper-listbox>
            </paper-dropdown-menu>
          </div>
					<div class="w3-row w3-light-grey w3-padding">
						<paper-button raised class="w3-blue" on-tap="updateUserType">
              <iron-icon icon="app:send"></iron-icon>&nbsp;SUBMIT
            </paper-button>
					</div>
				</div>
			</div>
		</div>

    <!-- <div class="container search-bar">
      <paper-search-bar hide-filter-button="true" placeholder="Search for Staff Members"></paper-search-bar>
    </div>  -->
    <div class="add-users-bar w3-card-1">
      <paper-button raised class="custom indigo w3-small" on-tap="newUserDialog">
        <iron-icon icon="app:person-add"></iron-icon>&nbsp; Add User
      </paper-button>
      <paper-button raised class="custom indigo w3-small" on-tap="uploadUsersDialog">
        <iron-icon icon="app:group-add"></iron-icon>&nbsp; Upload Users (xls)
      </paper-button>
    </div>
    <div class="content fadeInUp">
      <ul class="w3-ul w3-card-2 w3-hoverable">
        <template is="dom-repeat" items="[[usersData]]" as="item" initial-count="10" target-framerate="10">
          <li class="w3-bar" style="padding: 8px 0;">
            <img class="w3-third w3-padding-small w3-circle" style="width:36px; height: 36px;" src="[[_profilePhoto(item.photoURL)]]">
            <div class="w3-rest w3-bar-item" style="min-width:280px;">
              <span class="w3-medium w3-text-dark-gray">[[item.firstName]] [[item.lastName]]</span><span class$="[[_isDisabled(item.disabled)]] w3-tag w3-tiny w3-round">[[_isDisabledText(item.disabled)]]</span><br>
              <span class="w3-margin-bottom">[[item.email]]</span><br>
              <br>
              <span class="followBTNOther following w3-padding w3-card w3-hover-blue-gray" style="cursor:pointer;" on-tap="_openUserTypeModal" data="[[item.userID]]">[[_getUserTypeDesc(item.userType)]] <iron-icon icon="app:arrow-drop-down-circle"></iron-icon></span>
            </div>
            <!--  This is the Trash icon -->
            <paper-icon-button isdisabled="[[item.disabled]]" username="[[item.firstName]] [[item.lastName]]" data="[[item.userID]]"
              icon="myicons:delete" class="custom indigo w3-right" on-tap="deleteAccount"></paper-icon-button>
              
            <paper-icon-button isdisabled="[[item.disabled]]" username="[[item.firstName]] [[item.lastName]]" data="[[item.userID]]"
              icon$="[[_statusIcon(item.disabled)]]" class="custom indigo w3-right" on-tap="disableAccount"></paper-icon-button>

          </li>
        </template>
      </ul>
    </div>
    <div class="w3-row w3-center" style="width: 100%">
      <div class="w3-row" style="width: 100%">
        <paper-spinner active="{{isloadingmore}}"></paper-spinner>
      </div>
      <div class="w3-row w3-text-green" style="width: 100%">
        <paper-button hidden="{{loadmore}}" on-tap="_loadMorePosts">Load More Users</paper-button>
      </div>

    </div>
    <div id="snackbar"></div>
  </template>

  <script>
    var _ua = window.navigator.userAgent;
    var scrollTopPosition
    iOS = /iPad|iPhone|iPod/.test(_ua),
      iOS11 = /OS 11_0|OS 11_1|OS 11_2|OS 11_3/.test(_ua);

    class CompanyStaff extends Polymer.Element {
      static get is() {
        return 'company-staff';
      }
      ready() {
        super.ready();

        var that = this;

        Polymer.RenderStatus.afterNextRender(this, () => {
          var modal = Polymer.dom(this.root).querySelector('#myModal');
          var modalsingleUser = Polymer.dom(this.root).querySelector('#singleUser');
          var span = Polymer.dom(this.root).querySelector('#closeModal');
          var spanSingleUSer = Polymer.dom(this.root).querySelector('#closeSingleUser');
          var pickFileLabel = Polymer.dom(this.root).querySelector('#pickFileLabel');
          var hideRemoveFile = Polymer.dom(this.root).querySelector('#hideRemoveFile');
          var filename = Polymer.dom(this.root).querySelector('#filename');
          var selectFileForm = Polymer.dom(this.root).querySelector('#selectFileForm');
          var that = this;

          if((this._companyid == "-KgsUcgfo7z1U9MXgd9i") || (this._companyid=="-LDVbbRyIMhukVtTVQ0n") ){
            this._isSuperAdmin = true;
          }

          span.addEventListener('click', function (e) {
            pickFileLabel.style = "display: block;";
            filename.innerHTML = "";
            hideRemoveFile.style = "display: none";
            selectFileForm.reset();
            modal.style.display = "none";
          });

          spanSingleUSer.addEventListener('click', function (e) {
            // ios 11 bug caret position
            if (iOS && iOS11) {
              that.removeIOSBugfix();
            }
            this.selectedCategory = "";
            modalsingleUser.style.display = "none";
          });

          // this.$.users.disabled=false;
          Polymer.dom(this.root).querySelector('#users').disabled = false;
        });

        
      }
      static get properties() {
        return {
          user: {
            type: Object
          },
          _companyid: String,
          minData: {
            type: Number,
            value: 50
          },
          usersData: {
            type: Object,
            observer: '_onusersDataDataReceived'
          },
          loadmore: {
            type: Boolean,
            value: true
          },
          _isSuperAdmin: {
            type: Boolean,
            value: false
          },
          isloadingmore: {
            type: Boolean,
            value: true
          },
          edituserid:{
            type:String,
            value: ""
          }
        };
      }
      _getUserTypeDesc(type){
        var userTypes = {
          4: "Global Contributor",
          5: "Master Contributor",
          7: "Company Admin",
          8: "Standard User",
          10: "Corporate I-Leader",
          11: "Organisation Contributor",
        }

        var typedesc = userTypes[type];

        return typedesc ? typedesc : "Standard User";
      }
      _getUserType(type){
        var userTypes = {
          "Global Contributor": 4,
          "Master Contributor": 5,
          "Company Admin": 7,
          "Standard User": 8,
          "Corporate I-Leader": 10,
          "Organisation Contributor": 11
        }

        var typedesc = userTypes[type];

        return typedesc ? typedesc : 8;
      }
      updateUserType(){
        let database = firebase.database();

        var that = this;
        const userProfile = this.usersData.find((value) => value.userID === that.edituserid ? value : null);
        var selected = this.selectedType;
        var uid = userProfile.uid;
        var userID = userProfile.userID;
        var companyID = userProfile.companyID;
        var userType = this._getUserType(selected);

        var currUserType = this.user.userType;
        var currUserID = this.user.userID;

        if(currUserID == userID){
          if((currUserType == 7) && (userType != 7) ){
            this.showSnackBar('Could not remove Admin Role from your own account!');
            return
          }
        }

        // Update user data 
        let updates = {};
        updates['/users/' + userID + '/companyID_userType'] = companyID+"_"+userType;
        updates['/users/' + userID + '/userType'] = userType;
        updates['/users/' + userID + '/userDescription'] = selected;
        updates['/user/' + uid + '/companyID_userType'] = companyID+"_"+userType;
        updates['/user/' + uid + '/userType'] = userType;
        updates['/user/' + uid + '/userDescription'] = selected;

        this._closeUserTypeModal();
        database.ref().update(updates).then(()=>{
          that.showSnackBar('User updated successfully.');
        }).catch(()=>{
          that.showSnackBar('Error updating user details.');
        });
        
      }
      _openUserTypeModal(e){
        this.edituserid = e.currentTarget.data;
        var that = this;
        const userProfile = this.usersData.find((value) => value.userID === that.edituserid ? value : null);
        this.selectedType = this._getUserTypeDesc(userProfile.userType);

        // ios 11 bug caret position
        if (iOS && iOS11) {
          this.addIOSBugfix();
        }
				var modal = Polymer.dom(this.root).querySelector('#user-type');
				modal.style.display = 'block';
			}

			_closeUserTypeModal(){
        // ios 11 bug caret position
        if (iOS && iOS11) {
          this.removeIOSBugfix();
        }

				var modal = Polymer.dom(this.root).querySelector('#user-type');
				modal.style.display = 'none';
			}
      _loadMorePosts() {
        this.scrollPos = window.scrollY;
        this.isloadingmore = true;
        this.minData += 50;
      }
      _onusersDataDataReceived(newData, oldData) {
        var that = this;
        if (newData.length > 0) {
          this.loadmore = false;
          this.isloadingmore = false;

          setTimeout(function () {
            window.scrollTo({
              top: that.scrollPos,
              behavior: "instant"
            });
          }, 1000);
        }

        setTimeout(function () {
          that.loadmore = false;
          that.isloadingmore = false;

        }, 25000)
      }
      attached() {
        // Use the document element
        this.$.list.scrollTarget = this.ownerDocument.documentElement;
      }
      getClassForItem(item, selected) {
        return selected ? 'item expanded' : 'item';
      }
      disableAccount(e) {
        let userID = e.target.data;
        let userName = e.target.username;
        let active = e.target.isdisabled
        let disabled = true;
        let disabledText = 'Deactivate';

        const userProfile = this.usersData.find((value) => value.userID === userID ? value : null);
        var currUserID = this.user.userID;

        if(currUserID == userProfile.userID){
          this.showSnackBar('Cannot deactivate your own account!');
          return
        }

        active ? disabled = false : true;
        disabled ? disabledText = 'Deactivate' : disabledText = 'Activate';

        if (confirm(disabledText + ' selected account: ' + userName + '?')) {
          // Get a reference to the database service
          let database = firebase.database();

          // Update user data 
          let updates = {};
          updates['/users/' + userID + '/disabled'] = disabled;
          database.ref().update(updates);
        }
      }

      findObjectByKey(array, key, value) {
        for (var i = 0; i < array.length; i++) {
          if (array[i][key] === value) {
            return array[i];
          }
        }
        return null;
      }


      findAndDeleteDocument(documentPathUrl, objectId) {
        // Get a reference to the database service
        const database = firebase.database();
        database.ref(`${documentPathUrl}/${objectId}`).remove();

      }

      // Delete User account from DB
      async deleteAccount(e) {

        try {
          //Get user data from targeted event
          const {
            data,
            username
          } = e.target;

          const userProfile = this.usersData.find((value) => value.userID === data ? value : null);

          var currUserID = this.user.userID;

          if(currUserID == userProfile.userID){
            this.showSnackBar('Cannot delete your own account!');
            return
          }

          //TODO: User Paper Dialog to Confirmation with (Yes) / (No) buttons 
          //Confirm user deletion action 

          const answerEmail = prompt(
            `Are your sure you want to remove ${userProfile.firstName} ${userProfile.lastName} \n ( Please type in the email of the User !) `
          );

          if (answerEmail === '' || answerEmail === null || answerEmail !== userProfile.email) {
            this.showSnackBar('User not deleted: Incorrect email address provided.');
            return;
          }

          // Remove user object from subscribed, users, user , if any 
          this.findAndDeleteDocument('subscribed', userProfile.userID);
          this.findAndDeleteDocument('users', userProfile.userID);
          this.findAndDeleteDocument('user', userProfile.uid);

          this.showSnackBar(`Deleted ${userProfile.firstName} ${userProfile.lastName} successfully!`);
        } catch (error) {

          console.log(error);

        } // end try-catch block

      } // end deleteAccount func

      _isDisabled(disabled) {
        return disabled ? "w3-red" : "w3-green";
      }
      _isDisabledText(disabled) {
        return disabled ? "Disabled" : "Active";
      }
      _statusIcon(disabled) {
        return disabled ? "app:check" : "myicons:cancel";
      }
   
      uploadUsersDialog() {
        var modal = Polymer.dom(this.root).querySelector('#myModal');
        modal.style.display = "block";
      }
      checkfile(e) {
        var validExts = new Array(".xlsx", ".xls");
        var fileName = e.target.files[0].name;

        var fileExt = fileName.substring(fileName.lastIndexOf('.'));

        if (validExts.indexOf(fileExt) < 0) {
          this.$.hideRemoveFile.style = "display: none";
          this.$.filename.innerHTML = fileName;

          this.showSnackBar("Invalid file selected, valid files are of " +
            validExts.toString() + " types.");
          return false;
        } else {
          this.$.hideRemoveFile.style = "display: block";
          this.$.filename.innerHTML = fileName;

          return true;
        }
      }
      removeFile() {
        var pickFileLabel = this.$.pickFileLabel;
        this.$.hideRemoveFile.style = "display: none";
        this.$.filename.innerHTML = "";
        pickFileLabel.style = "display: block;";
        var selectFileForm = Polymer.dom(this.root).querySelector('#selectFileForm');
        selectFileForm.reset();
      }
      showSnackBar(msg) {
        var x = this.$.snackbar;
        x.innerHTML = msg;
        x.className = "show";
        setTimeout(function () {
          x.className = x.className.replace("show", "");
        }, 3000);
      }
      isEqual(a, b) {
        return a === b;
      }
      newUserDialog() {
        // ios 11 bug caret position
        if (iOS && iOS11) {
          this.addIOSBugfix();
        }
        var modal = Polymer.dom(this.root).querySelector('#singleUser');
        modal.style.display = "block";
      }
      createNewUser() {
        var span = Polymer.dom(this.root).querySelector('#closeSingleUser');
        var email = this.$.email.value;
        var firstName = this.$.firstName.value;
        var lastName = this.$.lastName.value;

        var emailVal = this.$.email.validate();
        var firstNameVal = this.$.firstName.validate();
        var lastNameVal = this.$.lastName.validate();

        // let companyID = "-LDVbbRyIMhukVtTVQ0n";
        // let companyName = "OneConnect Technologies";
        // let companyID = "-KgsUcgfo7z1U9MXgd9i";
        // let companyName = "Global Leadership Platform";
        // let companyID = "-LFWwJDGboULCmA0aC_9";
        // let companyName = "McDonald's";
        let companyID = this.user.companyID;
        let companyName = this.user.companyName;

        // Validate thought category
        if ((this.selectedCategory == undefined) || (this.selectedCategory == -1)) {
          this.showSnackBar("Please select user category!");
          return;
        }

        let userDescription = "Standard User";
        let userType = 8;

        if (this.selectedCategory == "Global Contributor") {
          userDescription = this.selectedCategory;
          userType = 4;
        } else if (this.selectedCategory == "Master Contributor") {
          userDescription = this.selectedCategory;
          userType = 5;
        } else if (this.selectedCategory == "Company Admin") {
          userDescription = this.selectedCategory;
          userType = 7;
        } else if (this.selectedCategory == "Standard User") {
          userDescription = this.selectedCategory;
          userType = 8;
        } else if (this.selectedCategory == "Corporate I-Leader") {
          userDescription = this.selectedCategory;
          userType = 10;
        } else if (this.selectedCategory == "Organisation Contributor") {
          userDescription = this.selectedCategory;
          userType = 11;
        }

        // get date and time
        var timeInMs = Date.now();
        var datetime = new Date(timeInMs);
        // format date
        datetime = this.formatDate(datetime);

        // Get a reference to the database service
        var database = firebase.database();

        if (!email || !emailVal) {
          this.showSnackBar("Email is required!");
          return;
        } else if (!firstName || !firstNameVal) {
          this.showSnackBar("Firstname is required!");
          return;
        } else if (!lastName || !lastNameVal) {
          this.showSnackBar("Lastname is required!");
          return;
        } else {
          var userID = database.ref().child('newUploadUsers').push().key;
          var defPassword = Math.random().toString(36).substring(2, 6) + Math.random().toString(36).substring(2, 6);
          defPassword = defPassword.toUpperCase();

          var data = {
            "companyID": companyID,
            "companyName": companyName,
            "dateRegistered": timeInMs,
            "email": email,
            "firstName": firstName,
            "lastName": lastName,
            "password": defPassword,
            "stringDateRegistered": datetime,
            "userDescription": userDescription,
            "newUploadUserID": userID,
            "userType": userType,
            "companyID_userType": companyID + "_" + userType
          }

          // Write the new rating data
          var updates = {};
          updates['/newUploadUsers/' + userID] = data;
          database.ref().update(updates);

          this.$.email.value = "";
          this.$.firstName.value = "";
          this.$.lastName.value = "";
          this.selectedCategory = "";

          span.click();
          this.showSnackBar("User created successfully!");
        }
      }
      uploadNewUsers() {
        var span = Polymer.dom(this.root).querySelector('#closeModal');
        var files = Polymer.dom(this.root).querySelector('#file-uploader').files;
        var i, f;

        let companyID = this.user.companyID;
        let companyName = this.user.companyName;
        // get date and time
        var timeInMs = Date.now();
        var datetime = new Date(timeInMs);
        // format date
        datetime = this.formatDate(datetime);

        // Get a reference to the database service
        var database = firebase.database();

        for (i = 0, f = files[i]; i != files.length; ++i) {
          var reader = new FileReader();
          var name = f.name;
          reader.onload = function (e) {

            var data = e.target.result;
            var workbook = XLSX.read(data, {
              type: 'binary'
            });

            function to_json(workbook) {
              var result = {};
              workbook.SheetNames.forEach(function (sheetName) {
                var roa = XLSX.utils.sheet_to_row_object_array(workbook.Sheets[sheetName]);
                if (roa.length > 0) {
                  result[sheetName] = roa;
                }
              });
              return result;
            }

            var xls_json = to_json(workbook);
            var users;
            // console.log('xls json: '+JSON.stringify(xls_json));
            Object.keys(xls_json).forEach(key => {
              users = xls_json[key];
              users.forEach((userobj, index) => {
                var email = userobj.Email;
                if (email !== undefined && email.length > 5) {
                  var userID = database.ref().child('newUploadUsers').push().key;
                  var defPassword = Math.random().toString(36).substring(2, 6) + Math.random().toString(
                    36).substring(2, 6);
                  defPassword = defPassword.toUpperCase();

                  var data = {
                    "companyID": companyID,
                    "companyName": companyName,
                    "dateRegistered": timeInMs,
                    "email": userobj.Email,
                    "firstName": userobj.Firstname,
                    "lastName": userobj.Lastname,
                    "password": defPassword,
                    "stringDateRegistered": datetime,
                    "userDescription": "Standard User",
                    "newUploadUserID": userID,
                    "userType": 8,
                    "companyID_userType": companyID + "_8"
                  }

                  // Write the new rating data
                  var updates = {};
                  updates['/newUploadUsers/' + userID] = data;
                  database.ref().update(updates);
                }

              });
            });

            /* DO SOMETHING WITH workbook HERE */
          };
          reader.readAsBinaryString(f);
        }

        span.click();
        this.showSnackBar("Users uploaded successfully!");
      }
      formatDate(date) {
        var d = new Date(date),
          month = '' + (d.getMonth() + 1),
          day = '' + d.getDate(),
          year = d.getFullYear(),
          hours = '' + d.getHours(),
          minutes = '' + d.getMinutes(),
          seconds = '' + d.getSeconds(),
          milliseconds = '' + d.getMilliseconds();

        var today = new Date(),
          thisYear = today.getFullYear();

        // get week day name Sunday - Saturday
        var dayName = this.getDayMonthStr(d.getDay(), "day", true);

        // get month name
        var monthName = this.getDayMonthStr(d.getMonth(), "month", true);

        // add preceding zeros where needed
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        if (hours.length < 2) hours = '0' + hours;
        if (minutes.length < 2) minutes = '0' + minutes;
        if (seconds.length < 2) seconds = '0' + seconds;
        if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

        // format thoughts date
        // Monday, 04 December 2017 14:21:56
        var thoughtDate = dayName + ", " + day + " " + monthName + " " + year + " " + hours + ":" + minutes + ":" +
          seconds;

        return thoughtDate;
        // return [year, month, day].join('-');
      }
      getDayMonthStr(val, dateParam, long) {
        // days
        var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
        var daysShort = ["Sun", "Mon", "Tue", "Wed", "Thur", "Fri", "Sat"];

        // Months
        var monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September",
          "October", "November", "December"
        ];
        var monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];

        if (dateParam == "day" && long == true) {
          // return day in long format
          return days[val];
        } else if (dateParam == "day" && long == false) {
          // return days in short
          return daysShort[val];
        }
        if (dateParam == "month" && long == true) {
          // return month in long format
          return monthNames[val];
        } else if (dateParam == "month" && long == false) {
          // return month in short
          return monthNamesShort[val];
        }

      }
      _profilePhoto(photo) {
        let photo_url = "../images/default-user.png";

        if (photo == undefined) {
          photo_url = "../images/default-user.png";
        } else if (photo == "") {
          photo_url = "../images/default-user.png";
        } else {
          photo_url = "" + photo;
        }

        return photo_url;
      }
      addIOSBugfix() {
        // Get scroll position before moving top
        scrollTopPosition = $(document).scrollTop();
        console.log('iOS device')
        // Add CSS to body "position: fixed"
        $("body").addClass("iosBugFixCaret");
        // $("body").css('position: fixed!important; width: 100%!important;');
      }

      removeIOSBugfix() {
        // Remove CSS to body "position: fixed"
        $("body").removeClass("iosBugFixCaret");

        //Go back to initial position in document
        $(document).scrollTop(scrollTopPosition);
      }
    }

    window.customElements.define(CompanyStaff.is, CompanyStaff);
  </script>
</dom-module>