<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="manifest" href="/manifest.json">

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">

<!-- Firebase -->
<link rel="import" href="../bower_components/polymerfire/firebase-app.html">

<!-- Firebase Auth -->
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<!-- Firebase Query -->
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-database-behavior.html">

<link rel="import" href="../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/l2t-paper-rating/l2t-paper-rating.html">
<link rel="import" href="app-icons.html">

<dom-module id="comments-box">
	<template>
		<link rel="import" href="shared-styles.html">
		<style include="w3-styles">
			
			.comment-box .comments-bar {
				margin-top: 5px;
				border-top: 1px solid rgb(158, 160, 167);
			}

			.w3-app-text{
				color: var(--app-primary-color);
			}

			.comments-bar .bar-item {
				cursor: pointer;
				font-size: 12px;
				color: #656565;
			}

			.comments-bar .bar-item.selected {
				background-color: #e1e8f7;
				color: #1298f1;
			}

			.comments-ratings-holder {
				height: 175px;
				max-height: 175px;
				overflow: hidden;
				position: relative;
			}

			.comments-ratings-holder .mask {
				position: absolute;
				top: 60px;
				right: 0px;
				cursor: pointer;
				bottom: 0px;
				left: 0px;
				z-index: 9;
				background: linear-gradient(rgba(255, 255, 255, 0),rgba(255, 255, 255, 0.67),rgba(255, 255, 255, 1));
			}

			.comments-ratings-holder .mask:hover {
				cursor: pointer;
				background: linear-gradient(rgba(250,250,250, 0),rgba(250,250,250, 0.47),rgba(250,250,250, 0.8));
			}

			.comments-ratings-holder .mask .text {
				position: absolute;
				right: 0px;
				bottom: 0px;
				left: 0px;
				padding: 5px;
				text-align: center;
				cursor: pointer;
			}

			.comments-ratings-holder.opened {
				height: unset;
				max-height: unset;
				overflow-y: unset;
				padding-bottom: 10px;
				border-bottom:6px solid #ebeaea;
			}

			.w3-darker {
				background-color: rgba(0, 0, 0, 0.1);
			}

			.comments-ratings-holder.opened .mask {
				display: none;
			}

			.commentor-photo{
				background-repeat: no-repeat;
				background-size: cover;
				display: inline-block;
				width: 42px;
				height: 42px;
				margin: 12px;
				border-radius: 50%;
				box-shadow: 0px 0px 5px rgba(0,0,0,0.3);
			}

			.comment-box-author{
				padding: 12px 7px 0px;
			}

			.comment-box-text{
				padding: 3px 7px;
				font-size: 11pt;
				color:#444;
			}

			.rate-color-post {
				--rating-icon-color: red;
				--rating-ink-color: blue;
			}

			.comment-message{
				background-color: #e9e9e9; 
				border:2px solid #d2d2d2;
				padding:7px 10px;
				box-shadow:0px 0px 10px #c3c3c3;
				margin: 10px;
				border-radius:25px;
			}

			.rate-color-posted {
				--rating-icon-color: rgb(10, 62, 129);
				--rating-ink-color: rgb(73, 23, 29);
			}

			.crh-row:nth-child(odd){
				background-color: rgba(0,0,0,0.03);
				border-bottom:1px solid rgba(0,0,0,0.035);
			}


			
			.loader {
				border: 4px solid #f3f3f3;
				border-radius: 50%;
				border-top: 5px solid #3498db;
				width: 14px;
				height: 14px;
				-webkit-animation: spin 1s linear infinite; /* Safari */
				animation: spin 1s linear infinite;
			}

			/* Safari */
			@-webkit-keyframes spin {
				0% { -webkit-transform: rotate(0deg); }
				100% { -webkit-transform: rotate(360deg); }
			}

			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
			}
			.comments-box{
				cursor: pointer!important;
			}
			paper-fab {
				/* position: absolute;
				top: -28px;
				right: 40px; */
				--paper-fab-background: #EF5458;
				--paper-fab-keyboard-focus-background: #DF4448;
			}
		</style> 
		<div class="comments-box" on-tap="_openModal">
			<div class="comments-bar w3-row w3-darker">
				<!-- <paper-fab icon="{{__computeFavIcon(__favorite)}}" on-tap="__toggleFavorite"></paper-fab> -->
				<paper-button class="bar-item w3-left selected" on-tap="_toggleCRHItem" crhType="comments">
					<paper-ripple></paper-ripple>
					<iron-icon icon="app:forum" class="w3-margin-right"></iron-icon>
					<span class="w3-new-badge w3-small w3-blue">[[_getCount(item.comments)]]</span>
				</paper-button>
				<paper-button class="bar-item w3-left" on-tap="_toggleCRHItem" crhType="ratings">
					<paper-ripple></paper-ripple>
					<iron-icon icon="app:star" class="w3-margin-right"></iron-icon>
					<span class="w3-new-badge w3-small w3-blue">[[_getCount(item.ratings)]]</span>
				</paper-button>
				
			</div>
			<div class="w3-padding w3-center comment-message w3-hide">west</div>
			<div class="comments-ratings-holder w3-row">
				<template is="dom-if" if="[[_hasComments(item.comments, item.ratings)]]">
					<div class="mask" on-tap="_openAllComments">
						<div class="text w3-text-blue w3-hover-text-green">View all </div>
					</div>
				</template>
				<div class="crh-item w3-animate-left comments">
					<div class="w3-row add-comment-form">
						<div class="w3-right w3-padding-large w3-margin w3-relative w3-text-grey w3-hover-text-dark-grey">
							<paper-ripple></paper-ripple>
							<iron-icon icon="app:send" on-tap="_saveComment"></iron-icon>
						</div>
						<div class="w3-left">
								<div style$="[[_profilePhoto(user.photoURL)]]" class="commentor-photo"></div>
						</div>
						<div class="w3-rest">
							<paper-textarea rows="1" class="_myComment" multiple label="Leave a comment..." type="text" auto-validate> </paper-textarea> 
						</div>
					</div>
					<template is="dom-if" if="[[_noComments(item.comments)]]">
						<div class="w3-padding w3-text-grey w3-center w3-margin-bottom">No comments yet.</div>
					</template>
					<template is="dom-repeat" items="{{_sortComments(item.comments)}}" as="comment">
						<div class="w3-row crh-row">
							<div class="w3-left">
									<div style$="[[_profilePhoto(comment.photoURL)]]" class="commentor-photo"></div>
							</div>
							<div class="w3-rest">
								<div class="comment-box-author w3-app-text">
									<b>[[comment.journalUserName]]</b>
									<span class="w3-margin-left w3-text-grey">[[timeSince(comment.date)]]</span>
								</div>
								<div class="comment-box-text">[[comment.comment]]</div>
							</div>
						</div>
					</template>
				</div>
				<div class="crh-item w3-animate-left w3-hide ratings">
					<div class="w3-padding w3-text-dark-grey w3-small">Rate this [[thetype]]</div>
					<div class="w3-row">
						<div class="w3-left">
							<div style$="[[_profilePhoto(user.photoURL)]]" class="commentor-photo"></div>
						</div>	
						<!-- <div class="w3-right w3-padding-small w3-relative w3-text-grey w3-hover-text-dark-grey" style="margin-top:20px;">
							<paper-ripple></paper-ripple>
							<iron-icon icon="app:send" on-tap="_saveRateValue"></iron-icon>
						</div> -->
						<div class="w3-rest w3-padding-tiny">
							<div class="comment-box-author w3-app-text">
								<b>[[user.firstName]] [[user.firstName]]</b>
								<span class="w3-margin-left w3-text-grey">[[timeSince(itemDate)]]</span>
							</div>
							<div class="comment-box-text w3-small">
								<l2t-paper-rating rating="{{itemrating}}" class="rate-color-posted" total="5"></l2t-paper-rating>
							</div>
						</div>
					</div>
					<template is="dom-if" if="[[_noComments(item.ratings)]]">
						<div class="w3-padding w3-text-grey w3-center w3-margin-bottom">No ratings yet.</div>
					</template>
					<template is="dom-repeat" items="{{_sortComments(item.ratings)}}" as="rating">
						<template is="dom-if" if="[[isNotCurrentUser(rating.journalUserID)]]">
							<div class="w3-row crh-row">
								<div class="w3-left">
									<div style$="[[_profilePhoto(rating.photoURL)]]" class="commentor-photo"></div>
								</div>
								<div class="w3-rest">
									<div class="comment-box-author w3-app-text">
										<b>[[rating.journalUserName]]</b>
										<span class="w3-margin-left w3-text-grey">[[timeSince(rating.date)]]</span>
									</div>
									<div class="comment-box-text w3-small">
										<l2t-paper-rating rating="[[rating.rating]]" readonly class="rate-color-posted rated-icons"></l2t-paper-rating>
									</div>
								</div>
							</div>
						</template>
					</template>
				</div>
			</div>
		</div>
	</template>

	<script>
		class CommentsBox extends Polymer.Element {
			static get is() { return 'comments-box'; }
			ready(){
				super.ready();
				var modalContent = Polymer.dom(this).parentNode;
				var modal = $(modalContent).parents('.modal-div');
				var that = this;
				modal.on('click', '.closer-for-modal', function(){
					that._closeModal();
				});
			}
			static get properties() {
				return {
					user: {
						type: Object
					},
					firebaseref: {type: String},
					itemDate:{
						type: String
					},
					itemrating: {
						type: Number,
						observer: 'saveRatingChange'
					},
					videoChanged: {type:Boolean, value:true},
					firstTime: {type:Boolean, value:true},
					opened: {type: Boolean, value: false, notify: true, observer: '_showAllComments'},
					entityid: {type: String}, // This is the ID an entity like a thought, video, podcast etc.
					item: { //This is the entire entity comments and rating and all
						type: Object,
						observer: 'onCRHDataChanged'
					},
					thetype: { type: String }, //Can be thought, video, podcast etc.
					__favorite: {
						type: Boolean,
						value: false
					}
				};
			}
			
			isNotCurrentUser(user){
				return user != this.user.userID;
			}

			_getCount(itms) {
				return itms == undefined ? 0 : Object.keys(itms).length;
			}

			_showAllComments(nData, oData){
				var crh = Polymer.dom(this.root).querySelectorAll('.comments-ratings-holder');
				if (nData == true){
					$(crh).addClass('opened');
				}
				else{
					$(crh).removeClass('opened');
				}
			}

			_openModal(e){
				var modalContent = Polymer.dom(this).parentNode;
				var modal = $(modalContent).parents('.modal-div');
				if($(modal).find('.closer-for-modal').hasClass('w3-hide')){
					$(modal).find('.closer-for-modal').removeClass('w3-hide');
					modal.addClass('ldp-modal');
					$(modalContent).addClass('ldp-modal-content');
					$(modalContent).css('max-width', '600px');
					modal.css('display', 'block');
				}
			}

			_closeModal(e){
				var modalContent = Polymer.dom(this).parentNode;
				var modal = $(modalContent).parents('.modal-div');
				this.opened = false;
				modal.removeClass('ldp-modal');
				$(modalContent).removeClass('ldp-modal-content');
				$(modalContent).css('max-width', 'unset !important');
				// modal.css('display', 'flex');
				$(modal).find('.closer-for-modal').addClass('w3-hide');
			}

			_openAllComments(e){
				this.opened = true;
			}

			_showCommentBoxMessage(txt, temp=false){
				var msgBox = Polymer.dom(this.root).querySelectorAll('.comment-message');
				$(msgBox).animate({'opacity': 1});
			
				$(msgBox).html(txt);
				$(msgBox).removeClass('w3-hide');
				
				if(temp){
					window.setTimeout(function(){
						$(msgBox).animate({'opacity': 0}).addClass('w3-hide');
					},temp);
				}
			}

			_closeCommentBoxMessage(){
				var msgBox = Polymer.dom(this.root).querySelectorAll('.comment-message');
				$(msgBox).animate({'opacity': 0}).addClass('w3-hide');
			}

			_sortComments(obj) {
				if (obj != undefined) {
					// var modObj = obj;
					// modObj.sort();
					return Object.keys(obj).map(function (key) {
						return obj[key];
					});
				}
			}

			_hasComments(comms, ratns){ //Check whether comments exist
				var hasComments = comms == undefined ? false : (comms.length == 0 ? false : true);
				return hasComments ? true : (ratns == undefined ? false : (ratns.length == 0 ? false : true));
			}

			_noComments(arr){ //Check whether no comments exist
				return arr == undefined ? true : (arr.length == 0 ? true : false);
			}

			timeSince(date) {

				if(date == 0){ //If the itemDate is 0 then no comment/rating has been done on the item
					return 'Not Rated';
				}

				if (typeof date !== 'object') {
					date = new Date(date);
				}

				var seconds = Math.floor((new Date() - date) / 1000);
				var intervalType;

				var interval = Math.floor(seconds / 31536000);
				if (interval >= 1) {
					intervalType = 'year';
				} else {
					interval = Math.floor(seconds / 2592000);
					if (interval >= 1) {
						intervalType = 'month';
					} else {
						interval = Math.floor(seconds / 86400);
						if (interval >= 1) {
							intervalType = 'day';
						} else {
							interval = Math.floor(seconds / 3600);
							if (interval >= 1) {
								intervalType = "hour";
							} else {
								interval = Math.floor(seconds / 60);
								if (interval >= 1) {
									intervalType = "minute";
								} else {
									interval = seconds;
									intervalType = "second";
								}
							}
						}
					}
				}

				if (interval > 1 || interval === 0) {
					intervalType += 's';
				}

				return interval + ' ' + intervalType+' ago';
			};

			_toggleCRHItem(e) { //Handle switching between comments and ratings.
				var elem = e.currentTarget;
				var crhType = $(elem).attr('crhType');
				$(elem).addClass('selected').siblings().removeClass('selected');
				var crhItem = $(elem).parents('.comments-bar').siblings('.comments-ratings-holder').children('.crh-item.' + crhType);
				crhItem.removeClass('w3-hide').siblings('.crh-item').addClass('w3-hide');
				this.opened = true;
			}

			onCRHDataChanged(newData, oldData) {
				if(this.thetype == 'Video'){
					this.videoChanged = true;
					this.entityid = newData.videoID;
					this.itemrating = this.getUserRating(newData.ratings);
					this.itemDate = this.getUserDateRating(newData.ratings);
				}
				if(this.thetype != 'Video'){
					if(newData.ratings){
						this.itemrating = this.getUserRating(newData.ratings);
						this.itemDate = this.getUserDateRating(newData.ratings);
					}	
				}
			}

			saveRatingChange(newData, oldData){
				if(this.thetype != 'Video'){
					if(oldData!==undefined){
						this._saveRateValue();
					}
				}
				else{
					
					if(this.videoChanged == false){ // Not video being opened so legitimate rating change
						this._saveRateValue();
					}
					else{// if its false then the video has just been opened so do not save rating just change statis to video changed.
						this.videoChanged = false; 
					}
				}
			}

			_profilePhoto(photo){
				let photo_url = "background-image: url('../images/default-user.png');";

				if(photo == undefined){
					photo_url = "background-image: url('../images/default-user.png');";
				}else if(photo == ""){
					photo_url = "background-image: url('../images/default-user.png');";
				}else{
					photo_url = "background-image: url('"+photo+"');";
				}

				return photo_url;
			}

			getUserDateRating(rtObj){
				if(rtObj==undefined || rtObj == null){
					return 0;
				}
				var userID = this.user.userID;
				var rtObj = Object.values(rtObj);
				var result = rtObj.filter(function( obj ) {
					return obj.journalUserID == userID;
				});
				if(result.length > 0)
					return result[0].date == undefined ? 0 : result[0].date;
			}

			getUserRating(rtObj){
				if(rtObj==undefined || rtObj == null){
					return 0;
				}
				var userID = this.user.userID;
				var rtObj = Object.values(rtObj);
				var result = rtObj.filter(function( obj ) {
					return obj.journalUserID == userID;
				});
				if(result.length > 0)
					return result[0].rating == undefined ? 0 : result[0].rating;
			}

			_saveRateValue(){
				let dailyThought_ID = this.entityid;
				
				let rating = this.itemrating;
				let comment = "";

				var journalUserID = this.user.userID;
				var journalUserName = this.user.firstName+" "+this.user.lastName;

				var companyID = this.user.companyID;
				var companyName = this.user.companyName;

				var photoURL = "";

				if(this.user.photoURL != undefined || this.user.photoURL != ""){
					photoURL = this.user.photoURL;
				}else{
					photoURL = "";
				}

				if(photoURL == undefined){
					photoURL = "";
				}

				let date = Date.now();
				this.itemDate = date;
				let stringDate = this.formatDate(date);
				let stringRateDate = this.formatRateTime(date);
				// let stringDate = new Date(date).toUTCString();

				// Get a reference to the database service
				var database = firebase.database();

				var newRateKey = journalUserID;

				if(comment == undefined){
					comment = "";
				}

				// if rating not equal to undefined
				if(rating != undefined){
					// fix data
					// dailyThoughts
					var data = {
						companyID: companyID,
						companyName: companyName,
						journalUserID: journalUserID,
						journalUserName: journalUserName,
						photoURL: photoURL,
						comment: comment,
						dailyThoughtID: dailyThought_ID,
						date: date,
						rating: rating,
						ratingID: newRateKey,
						stringDate: stringDate,
						stringRateDate: stringRateDate
					}

					// Write the new rating on thoughts data
					database.ref(this.firebaseref).child(dailyThought_ID).child('ratings').child(journalUserID).set(data);
					
					this._showCommentBoxMessage("<span class='w3-text-red'>Rating posted successfully!</span>", 2000);
				}
			}

			_saveComment(e){
				var dailyThought_ID = this.entityid;
				var commentField = Polymer.dom(this.root).querySelectorAll('._myComment')[0];
				var comment = commentField.value;
				
				// Validate thought
				if ((comment == undefined) || (comment.trim() == "")){
					this._showCommentBoxMessage("<span class='w3-text-red'>Please enter a comment!</span>", 2000);
					return;
				}

				var journalUserID = this.user.userID;
				var journalUserName = this.user.firstName+" "+this.user.lastName;

				var companyID = this.user.companyID;
				var companyName = this.user.companyName;

				var photoURL = "";

				if(this.user.photoURL != undefined || this.user.photoURL != ""){
					photoURL = this.user.photoURL;
				}else{
					photoURL = "";
				}

				if(photoURL == undefined){
					photoURL = "";
				}

				let date = Date.now();
				let stringDate = this.formatDate(date);
				let stringCommentDate = this.formatRateTime(date);

				// Get a reference to the database service
				var database = firebase.database();

				var newCommentKey = database.ref().child('comments').push().key;

				if(comment == undefined){
					comment = "";
				}

				// fix data
				// dailyThoughts
				var data = {
					companyID: companyID,
					companyName: companyName,
					journalUserID: journalUserID,
					journalUserName: journalUserName,
					photoURL: photoURL,
					comment: comment,
					dailyThoughtID: dailyThought_ID,
					date: date,
					commentID: newCommentKey,
					stringDate: stringDate,
					stringCommentDate: stringCommentDate,
					postType: this.firebaseref
				}

				// Write the new comments on thoughts data
				this._showCommentBoxMessage('<span class="loader"></span> Saving the Comment');
				var newTypeCommentKey = database.ref().child('/'+this.firebaseref+'/' + dailyThought_ID +'/comments').push().key;
				var commentUpdates = {};
				commentUpdates['/'+this.firebaseref+'/'+dailyThought_ID+'/comments/'+newTypeCommentKey] = data;
				commentUpdates['/comments/'+newTypeCommentKey] = data;
				database.ref().update(commentUpdates);
				
				this._showCommentBoxMessage('<span class="w3-text-green">Comment Saved!</span>', 1000);
				commentField.value = "";
			}

			formatDate(date) {
				var d = new Date(date),
				month = '' + (d.getMonth() + 1),
				day = '' + d.getDate(),
				year = d.getFullYear(),
				hours = '' + d.getHours(),
				minutes = '' + d.getMinutes(),
				seconds = '' + d.getSeconds(),
				milliseconds = '' + d.getMilliseconds();

				var today = new Date(),
				thisYear = today.getFullYear();

				// get week day name Sunday - Saturday
				var dayName = this.getDayMonthStr(d.getDay(), "day", true);

				// get month name
				var monthName = this.getDayMonthStr(d.getMonth(), "month", true);

				// add preceding zeros where needed
				if (month.length < 2) month = '0' + month;
				if (day.length < 2) day = '0' + day;
				if (hours.length < 2) hours = '0' + hours;
				if (minutes.length < 2) minutes = '0' + minutes;
				if (seconds.length < 2) seconds = '0' + seconds;
				if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

				// format thoughts date
				// Monday, 04 December 2017 14:21:56
				var thoughtDate = dayName+", "+day+" "+monthName+" "+year+" "+hours+":"+minutes+":"+seconds;

				return thoughtDate;
				// return [year, month, day].join('-');
			}
			
			formatRateTime(date) {
				var d = new Date(date),
				month = '' + (d.getMonth() + 1),
				day = '' + d.getDate(),
				year = d.getFullYear(),
				hours = d.getHours() > 12 ? d.getHours() - 12 : d.getHours(),
				am_pm = d.getHours() >= 12 ? "PM" : "AM",
				minutes = '' + d.getMinutes(),
				seconds = '' + d.getSeconds(),
				milliseconds = '' + d.getMilliseconds();

				var today = new Date(),
				thisYear = today.getFullYear();

				// get week day name Sunday - Saturday
				var dayName = this.getDayMonthStr(d.getDay(), "day", true);

				// get month name
				var monthName = this.getDayMonthStr(d.getMonth(), "month", false);

				// add preceding zeros where needed
				if (month.length < 2) month = '0' + month;
				if (day.length < 2) day = '0' + day;
				// if (hours.length < 2) hours = '0' + hours;
				hours = hours < 10 ? "0" + hours : hours;
				if (minutes.length < 2) minutes = '0' + minutes;
				if (seconds.length < 2) seconds = '0' + seconds;
				if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

				// format thoughts date
				// 04 Dec 02:21:PM
				var thoughtDate = day+" "+monthName+" "+hours+":"+minutes+":"+am_pm;

				return thoughtDate;
				// return [year, month, day].join('-');
			}
			getDayMonthStr(val, dateParam, long){
				// days
				var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
				var daysShort = ["Sun","Mon","Tue","Wed","Thur","Fri","Sat"];

				// Months
				var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September","October", "November", "December"];
				var monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sep","Oct", "Nov", "Dec"];

				if(dateParam == "day" && long == true){
					// return day in long format
					return days[val];
				}
				else if(dateParam == "day" && long == false){
					// return days in short
					return daysShort[val];
				}
				if(dateParam == "month" && long == true){
					// return month in long format
					return monthNames[val];
				}
				else if(dateParam == "month" && long == false){
					// return month in short
					return monthNamesShort[val];
				}
				
			}
			__toggleFavorite(event, detail) {
				this.__favorite = !this.__favorite;
			}
			__computeFavIcon(favorite) {
				return favorite ? 'app:favorite' : 'app:favorite-border';
			}
		}

		window.customElements.define(CommentsBox.is, CommentsBox);
	</script>
</dom-module>