<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">

<dom-module id="my-notifications">
	<template>
		<style include="w3-styles"></style>
		<style include="shared-styles">
			:host {
				display: block;
			}

			.notification{
				cursor: pointer;
				position: relative;
			}

			li a{
				text-decoration: none;
				text-transform: none;
				color: inherit;
				display: block;
			}
			
		</style>

		<firebase-query
			id="qryusernotifications"
			path="/users/[[userid]]/notifications"
			limit-to-last="20"
			data="{{userNotificationData}}">
		</firebase-query>

		<div>
			<ul class="w3-ul w3-hoverable w3-margin-bottom">
				<hr>
				<template id="resultList" is="dom-repeat" items="{{userNotificationData}}" as="item" sort="_sort" observe="notificationDate">
					<li class="w3-bar notification" style$="[[_notificationOpened(item.opened)]]" on-tap="_notificationClicked" data="[[item]]">
						<paper-ripple></paper-ripple>
						<img class="w3-bar-item w3-circle w3-third" style="width:38px; height: 38px;" src="[[_profilePhoto(item.photoURL)]]">
						<div class="w3-rest">
							<span class="w3-medium"><b class="w3-text-dark-grey">[[item.journalUserName]]</b></span> <br>
							<span class="w3-small">[[item.notificationMsg]] | </span><span class="w3-tiny w3-text-grey">[[_notificationData(item.notificationDate)]]</span>
						</div>
					</li>
				</template>
			</ul>
			<div class="w3-row w3-center" style="width: 100%">
				<paper-spinner  active="{{isloading}}"></paper-spinner>
			</div>
		</div>
	</template>
	<script>

	class MyNotifications extends Polymer.Element {
		static get is() { return 'my-notifications'; }
		ready(){
			super.ready();
		}
		static get properties() {
			return {
				unread_notifications: {
					type: Number,
					value: 0
				},
				unreadstring: {
					type: String,
					value: "0",
					notify: true
				},
				isloading:{
					type: Boolean,
					value: true
				},
				rootpath: {type:String},
				userid: {
					type: String,
					notify: true
				},
				userNotificationData: {
					type: Object,
					observer: "userNotificationDataChanged"
				},
			};
		}

		_loadThisElement(nT,t){
			return nT == t;
		}

		userNotificationDataChanged(a, b){
			var notifications;
			var unread = 0;

			//Updates the following tab automatically
			var database = firebase.database();
			var that = this;
			var seen = false;

			if(a != undefined){
				var newCount = a.length;
                if(newCount > 0){
					var notificationsRef = database.ref('/users/'+this.userid+'/notifications').orderByChild("seen").equalTo(seen);

					notificationsRef.on('child_added', function(data) {
						var unread = 0;
						unread++;

						if(unread > 0) that.unread_notifications += unread;

						if(that.unread_notifications > 20) that.unreadstring = "20+";
						else that.unreadstring = ""+that.unread_notifications;
					});

					notificationsRef.on('child_removed', function(data) {
						var unread = 0;
						unread++;
						if(unread > 0) that.unread_notifications = that.unread_notifications - unread;

						if(that.unread_notifications > 20) that.unreadstring = "20+";
						else that.unreadstring = ""+that.unread_notifications;
					});

					this.isloading = false;
                }
			}else{
				this.isloading = false;
			}

			setTimeout(function(){
				that.isloading = false;
			},8000)
		}

		_notificationOpened(opened){
			if(opened === true){
				return 'padding: 8px 0; background-color: #fff;'
			}else{
				return 'padding: 8px 0; background-color: #eee;'
			}
		}

		_notificationSeen(nots){
			var myNotifications = {};

			$.each(nots, function(n, nt){
				myNotifications['/users/'+this.userid+'/notifications/'+n+'/seen'] = true
				myNotifications['/users/'+this.userid+'/notifications/'+n+'/opened'] = true
			});

			let database = firebase.database();
			database.ref().update(myNotifications);
		}

		getPage(typ){
			var pageMatcher = {
				'thought':'daily-thoughts',
				'pending-thought':'thoughts-management',
				'article':'leadership-articles',
				'podcast':'leadership-podcasts',
				'podcast':'leadership-podcasts',
				'pldpreminder': 'my-pldp',
				'video': 'leadership-videos'
			}		
			return pageMatcher[typ]	
		}

		_notificationClicked(e){
			var notification = e.currentTarget.data;
			let database = firebase.database();
			var myNotifications = {};
			var _userID = this.userid

			if(notification.notificationType === "pending-thought"){
				window.location = "./"+this.getPage(notification.notificationType);
			}else{
				myNotifications['/users/'+_userID+'/notifications/'+notification.newNotificationID+'/opened'] = true
				database.ref().update(myNotifications);

				window.location = "./"+this.getPage(notification.notificationType)+"/#"+notification.notificationItemID;

				this.removeFromParent();
			}

			let seen = false;
			
			database.ref('/users/'+this.userid+'/notifications').orderByChild("seen").equalTo(seen).once('value').then((data)=>{
				var myNotifications = data.val();
				if(myNotifications === null){;
				}else{
					this._notificationSeen(myNotifications)
				}
				
			}).catch(function(error) {
				// console.log("Error updating user notifications:", error);
			});
			
		}

		removeFromParent(){
			var a = Polymer.dom(this).parentNode;
			$(a).siblings('#close-notifications').trigger('click');
		}

		_profilePhoto(photo){
			let photo_url = "../images/default-user.png";

			if(photo == undefined){
				photo_url = "../images/default-user.png";
			}else if(photo == ""){
				photo_url = "../images/default-user.png";
			}else{
				photo_url = ''+photo+'';
			}

			return photo_url;
		}

		_sort(a, b) {  
			if (a.notificationDate > b.notificationDate) return -1;
			if (a.notificationDate < b.notificationDate) return 1;
			return 0;
		}

		_notificationData(dt){
			var date = new Date(dt);
			var day = date.getDate() < 10 ? '0'+date.getDate() : date.getDate();
			var locale = 'en-us';
			var month = date.toLocaleString(locale, { month: "long" });
			var year = date.getFullYear();

			return month+' '+day;
		}

	}
	window.customElements.define(MyNotifications.is, MyNotifications);
	</script>
</dom-module>