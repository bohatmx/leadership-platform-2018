<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="manifest" href="/manifest.json">

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<!-- Firebase Auth -->
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<!-- Firebase Query -->
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-database-behavior.html">

<link rel="lazy-import" href="daily-thoughts.html">

<dom-module id="my-notifications">
	<template>
		<style include="w3-styles"></style>
		<style include="shared-styles">
			:host {
				display: block;
			}

			.notification{
				cursor: pointer;
				position: relative;
			}

			li a{
				text-decoration: none;
				text-transform: none;
				color: inherit;
				display: block;
			}
			
		</style>

		<div >
			<ul class="w3-ul w3-hoverable w3-margin-bottom">
				<hr>
				<template id="resultList" is="dom-repeat" items="{{notificationsdata}}" as="item" sort="_sort" observe="notificationDate">
					<li class="w3-bar notification" style$="[[_notificationOpened(item.opened)]]" on-tap="_notificationClicked" data="[[item]]">
						<paper-ripple></paper-ripple>
						<img class="w3-bar-item w3-circle w3-third" style="width:38px; height: 38px;" src="[[_profilePhoto(item.photoURL)]]">
						<div class="w3-rest">
							<span class="w3-medium"><b class="w3-text-dark-grey">[[item.journalUserName]]</b></span> <br>
							<span class="w3-small">[[item.notificationMsg]] | </span><span class="w3-tiny w3-text-grey">[[_notificationData(item.notificationDate)]]</span>
						</div>
					</li>
				</template>
			</ul>
		</div>	
	</template>
	<script>

	class MyNotifications extends Polymer.Element {
		static get is() { return 'my-notifications'; }
		ready(){
			super.ready();
		}
		static get properties() {
			return {
				user: {
					type: Object
				},
				rootpath: {type:String},
				notificationsdata: {
					type: Object
				},
			};
		}

		_loadThisElement(nT,t){
			return nT == t;
		}

		_notificationOpened(opened){
			if(opened === true){
				return 'padding: 8px 0; background-color: #fff;'
			}else{
				return 'padding: 8px 0; background-color: #eee;'
			}
		}

		_notificationSeen(nots){
			var myNotifications = {};
			var _userID = this.user.userID;

			$.each(nots, function(n, nt){
				myNotifications['/users/'+_userID+'/notifications/'+n+'/seen'] = true
				myNotifications['/users/'+_userID+'/notifications/'+n+'/opened'] = true
			});

			let database = firebase.database();
			database.ref().update(myNotifications);
		}

		getPage(typ){
			var pageMatcher = {
				'thought':'daily-thoughts',
				'pending-thought':'thoughts-management',
				'article':'leadership-articles',
				'podcast':'leadership-podcasts',
				'podcast':'leadership-podcasts',
				'pldpreminder': 'my-pldp',
				'video': 'leadership-videos'
			}		
			return pageMatcher[typ]	
		}

		_notificationClicked(e){
			var notification = e.currentTarget.data;
			let database = firebase.database();
			var myNotifications = {};
			var _userID = this.user.userID;

			if(notification.notificationType === "pending-thought"){
				window.location = "./"+this.getPage(notification.notificationType);
			}else{
				myNotifications['/users/'+_userID+'/notifications/'+notification.newNotificationID+'/opened'] = true
				database.ref().update(myNotifications);

				window.location = "./"+this.getPage(notification.notificationType)+"/#"+notification.notificationItemID;
			}

			let seen = false;
			
			database.ref('/users/'+this.user.userID+'/notifications').orderByChild("seen").equalTo(seen).once('value').then((data)=>{
				var myNotifications = data.val();
				console.log('mynotifications', myNotifications);
				if(myNotifications === null){
					console.log("No notifications");
				}else{
					this._notificationSeen(myNotifications)
				}
				
			}).catch(function(error) {
				console.log("Error updating user notifications:", error);
			});
			
		}

		_profilePhoto(photo){
			let photo_url = "../images/default-user.png";

			if(photo == undefined){
				photo_url = "../images/default-user.png";
			}else if(photo == ""){
				photo_url = "../images/default-user.png";
			}else{
				photo_url = ''+photo+'';
			}

			return photo_url;
		}

		_sort(a, b) {  
			if (a.notificationDate > b.notificationDate) return -1;
			if (a.notificationDate < b.notificationDate) return 1;
			return 0;
		}

		_notificationData(dt){
			var date = new Date(dt);
			var day = date.getDate() < 10 ? '0'+date.getDate() : date.getDate();
			var locale = 'en-us';
			var month = date.toLocaleString(locale, { month: "long" });
			var year = date.getFullYear();

			return month+' '+day;
		}

	}
	window.customElements.define(MyNotifications.is, MyNotifications);
	</script>
</dom-module>