<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="manifest" href="/manifest.json">

<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/paper-search/paper-search-bar.html">
<link rel="import" href="../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">

<!-- iron elements  -->
<link rel="import" href="../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../bower_components/paper-styles/shadow.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/paper-input/paper-textarea.html">

<link rel="import" href="../bower_components/photo-gallery/photo-gallery.html">

<!-- paper rating -->
<link rel="import" href="../bower_components/l2t-paper-rating/l2t-paper-rating.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="shared-styles.html">
<link rel="import" href="load-media.html">

<dom-module id="post-thought">
  <template>
    <style include="shared-styles">
      :host {
        /* Label and underline color when the input is focused */
        --paper-input-container-focus-color: #fff;

        /* Label and underline color when the input is invalid */
        --paper-input-container-invalid-color: red;

        /* Input foreground color */
        --paper-input-container-label:{
          font-size: 12px;
          margin-bottom: 4px;
          color: #757575;
        };
        --paper-input-container-input-focus:{
          font-size: 14px;
          margin-bottom: 4px;
          color: var(--app-primary-text);
        };
      }
      .rate-color-post {
        --rating-icon-color: var(--app-primary-color);
        --rating-ink-color: var(--app-primary-color);
      }
      .rate-color {
        --rating-icon-color: #9e9e9e;
        --rating-ink-color: #9e9e9e;
      }
      .card-container{
        border: 1px solid #e6e6e6;
        margin-top: 10px;
        margin-bottom: 30px;
        background-color: #fff;
      }
      .comments-box{
        display: -webkit-flex;
        display: flex;
        padding: 10px 16px;
      }
      .comments-info{
        display: -webkit-flex;
        display: flex;
        flex-direction: column;
        max-width: 80%;
      }
      .comment-details{
        display: -webkit-flex;
        display: flex;
        flex-direction: row;
        margin-bottom: 6px;
      }
      .comment-author{
        margin-right: 16px;
        color: var(--app-primary-color);
      }
      .pageComments{
        padding: 0 8px;
        background-color: #f7f7f7;
      }
      .comment-date{
        color: #9e9e9e !important;
      }
      .comment-msg{
        color: var(--app-primary-text);
      }
      .comment-input{
        background-color: #ffffff;
        padding: 0 16px;
        border-radius: 2px;
      }
      .comment-area{
        display: flex;
        flex-direction: row;
        padding-bottom: 10px;
        padding-top: 10px;
      }
      .comment-input{
        flex-grow: 8;
        margin-left: -10px;
      }
      .comment-btn{
        margin: 10px;
        color: var(--app-primary-color);
      }
      .header-det{
        flex-grow: 9;
        display: flex;
      }
      .header-actions{
        flex-grow: 1;
        align-content: flex-end;
        justify-content: center;
      }
      .thought-rate-title, .thought-rate-subtitle{
        text-align: center;
      }
      .thought-rate-title{
        font-family: sans-serif;
        white-space: wrap;
        margin: 12px 0;
      }
      .thought-rate-subtitle{
        font-style: italic;
      }
      /* #media{
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        position: fixed;
        z-index: 10;
      } */
    </style>
    <div id="media"></div>
    <div class="container">
      <paper-dialog id="imgDialog"  class="image-dailog">
        <paper-dialog-scrollable>
            <iron-image class="thought-expand-img" sizing="cover" src="" id="showImage"></iron-image>
        </paper-dialog-scrollable>
        <div class="buttons">
          <paper-button dialog-dismiss>Close</paper-button>
        </div>
      </paper-dialog>
    </div>
    <div class="container">
      <paper-dialog id="pldpDialog">
        <h2><paper-icon-button icon="myicons:event-note" class="blue"></paper-icon-button>My PLDP</h2>
        <hr>
        <paper-dialog-scrollable>
            <p>Based on what you just read, would you like to add an Action to your PLDP (Personal Leadership Development Plan)?</p>
        </paper-dialog-scrollable>
        <hr>
        <div class="buttons">
        <paper-button dialog-dismiss>Close</paper-button>
          <a href="my-pldp" name="name" class="pldp-link">
            <paper-button on-tap="closePLDPDialog">Proceed</paper-button>
          </a>
      </div>
      </paper-dialog>
    </div>
    <div class="container">
      <paper-dialog id="videoDialog"  class="add-dailog">
        <div class="container video-side">
          <iframe id="videoPlayer" width="100%" height="315"
          src="" autoplay="false" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen>
          </iframe>
        </div>
        <div class="buttons">
          <paper-button dialog-dismiss>Close</paper-button>
        </div>
      </paper-dialog>
    </div>
    <main class="card-container fadeInUp">
      <div class="container card-header">
        <div class="header-det">
          <div class="card-avatar" style$="[[_profilePhoto(item.photoURL)]]"></div>
          <div class="container card-company-container">
            <div class="row card-company">[[item.companyName]]</div>
            <div class="row card-postedby">[[item.journalUserName]]</div>
          </div>
        </div>
        <div class="header-actions">
          <template is="dom-if" if="[[isEqual(thoughtype, 'mythoughts')]]">
            <a id="addThoughts" href="add-thoughts" class="add-thought-link">
              <paper-icon-button icon="create" on-tap="_editThought" id="edit[[item.dateRegistered]]" data="[[item.dailyThoughtID]]" class="tomato"></paper-icon-button>
            </a>
            <paper-icon-button icon="delete" on-tap="_deleteThought" id="del[[item.dateRegistered]]" data="[[item.dailyThoughtID]]"
            style="color: rgb(150, 150, 150)"></paper-icon-button>
          </template>
        </div>
      </div>
    
      <div class="container">
        <div class="row">
          <div class="thought-img" style$="[[_photo(item.photos)]]">
            <div class="thought-date">
              [[item.stringDateRegistered]]
            </div>
            <div class="thought-title">
              [[item.title]]
            </div>
            <div class="thought-author">
              [[item.subtitle]]
            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="row">
          <div class="card-actions">
            <div class="horizontal justified">
              <paper-icon-button class="blue" icon="myicons:small-link" on-click="toggle" data="[[item.dateRegistered]]" id="blue[[item.dateRegistered]]"></paper-icon-button>
              <paper-icon-button class="green" icon="myicons:small-mic" on-click="toggle" data="[[item.dateRegistered]]" id="green[[item.dateRegistered]]"></paper-icon-button>
              <paper-icon-button icon="myicons:small-videocam" on-click="toggle" data="[[item.dateRegistered]]" id="cam[[item.dateRegistered]]"></paper-icon-button>
              <paper-icon-button class="red" icon="myicons:small-image" on-click="toggle" data="[[item.dateRegistered]]" id="red[[item.dateRegistered]]"></paper-icon-button>
              <paper-icon-button class="red" icon="myicons:small-share" data="[[item.dailyThoughtID]]" id="share[[item.dateRegistered]]"></paper-icon-button>
              <paper-button id="pldp[[item.dateRegistered]]" class="red thought-actions pldp-text" data="[[item.dailyThoughtID]]" on-tap="_openPLDP">My PLDP</paper-button>
            </div>
            <div class="horizontal justified">
              <paper-button class="blue thought-actions">[[_objLen(item.urls)]]</paper-button>
              <paper-button class="green thought-actions">[[_objLen(item.podcasts)]]</paper-button>
              <paper-button class="thought-actions">[[_objLen(item.videos)]]</paper-button>
              <paper-button class="red thought-actions">[[_objLen(item.photos)]]</paper-button>
            </div>
          </div>
        </div>
      </div>

      <div class="container more-container">
        <iron-collapse id="collapse[[item.dateRegistered]]">
          <iron-pages selected="[[_selected]]" attr-for-selected="page-name">
            <div page-name="page-1-[[item.dateRegistered]]" id="page1[[item.dateRegistered]]">
              <template is="dom-repeat" items="{{_toArray(item.urls)}}" as="item1">
                <!-- <div class="container block-display">
                  <a class="more-links" target="_blank" href="[[item1.url]]">[[item1.title]]</a>
                </div> -->
                <div class="container block-display">
                  <a class="more-links" target="_blank" href="[[item1.url]]">[[item1.title]]</a>
                  <template is="dom-if" if="[[isEqual(thoughtype, 'mythoughts')]]">
                    <span class="close-square" id="delURL[[item1.dateRegistered]]" on-tap="_deleteThoughtURL" data="[[item1.lpUID]]" dataval="[[item.dailyThoughtID]]"></span>
                  </template>
                </div>
              </template>
            </div>
            <div page-name="page-2-[[item.dateRegistered]]" id="page2[[item.dateRegistered]]">
              <template is="dom-repeat" items="{{_toArray(item.podcasts)}}" as="item1">
                <!-- <div class="row audio-container card-shadow">
                  <a class="more-links" target="_blank" href="[[item1.url]]">[[item1.storageName]]</a>
                </div> -->
                <div class="container block-display">
                  <a class="more-links" target="_blank" href="[[item1.url]]">[[item1.storageName]]</a>
                  <template is="dom-if" if="[[isEqual(thoughtype, 'mythoughts')]]">
                    <span class="close-square" id="delPodcast[[item1.dateRegistered]]" on-tap="_deleteThoughtPodcast" data="[[item1.lpUID]]" dataval="[[item.dailyThoughtID]]" datapod="[[item1.podcastID]]"></span>
                  </template>
                </div>
              </template>
            </div>
            <div page-name="page-3-[[item.dateRegistered]]" id="page3[[item.dateRegistered]]">
              <template is="dom-repeat" items="{{_toArray(item.videos)}}" as="item1">
                <div class="container videos-list block-display">
                  <div class="video-thumbnail">
                    <img id="img[[item1.dateRegistered]][[item.dateRegistered]]" src$="[[getYoutubeThumbnail(item1.url)]]" alt="LP" style="width: 100px; height: auto; cursor: pointer;" data="[[item1.url]]" on-click="_videoClick">
                  </div>
                  <div class="video-desc">
                    <div class="row podcast-text" id="col[[item1.dateRegistered]][[item.dateRegistered]]" name="[[item1.dateRegistered]][[item.dateRegistered]]" on-click="_videoClick" data="[[item1.url]]" onmouseover="" style="cursor: pointer;">
                          [[_getVideoName(item1.storageName)]]
                    </div>
                  </div>
                  <template is="dom-if" if="[[isEqual(thoughtype, 'mythoughts')]]">
                    <span class="close-square" id="delVideo[[item1.dateRegistered]]" on-tap="_deleteThoughtVideo" data="[[item1.lpUID]]" dataval="[[item.dailyThoughtID]]" datavid="[[item1.videoID]]"></span>
                  </template>
                </div>
              </template>
            </div>
            <div page-name="page-4-[[item.dateRegistered]]" id="page4[[item.dateRegistered]]">
              <div class="row">
                <template is="dom-repeat" items="{{_toArray(item.photos)}}" as="item1">
                  <div class="wrapper">
                    <iron-image id="img[[item1.dateRegistered]]" class="avatar" sizing="cover" src="[[item1.url]]" on-click="_dialogImgOpen" onmouseover="" style="cursor: pointer;"></iron-image>
                    <template is="dom-if" if="[[isEqual(thoughtype, 'mythoughts')]]">
                      <span class="close" id="delImg[[item1.dateRegistered]]" on-tap="_deleteThoughtImg" data="[[item1.lpUID]]" dataval="[[item1.dailyThoughtID]]"></span>
                    </template>
                  </div>
                </template>
              </div>
            </div>
          </iron-pages> 
        </iron-collapse>
      </div>
      <div class="comments-card pageComments">
        <div>
          <table>
            <tr>
              <td>
                <paper-icon-button icon="app:forum" id="com[[item.dailyThoughtID]]" on-tap="toggleComRate" onmouseover="" data="[[item.dailyThoughtID]]"></paper-icon-button>[[_objLen(item.comments)]]
              </td>
              <td>
                <paper-icon-button id="rate[[item.dailyThoughtID]]" icon="app:star" on-tap="toggleComRate" data="[[item.dailyThoughtID]]"></paper-icon-button>[[_objLen(item.ratings)]]
              </td>
            </tr>
          </table>
        </div>
        <div class="commentRate">
            <iron-pages id="page[[item.dailyThoughtID]]" selected="0">
              <div class="pageComments" page-comrate="page-comment[[item.dailyThoughtID]]" id="page-comment[[item.dailyThoughtID]]">
                
                <template is="dom-repeat" items="{{_sortComments(item.comments)}}" as="item1">
                  <div class="comments-box">
                    <div class="card-avatar comment-avatar" style$="[[_profilePhoto(item1.photoURL)]]"></div>
                    <div class="comments-info">
                      <div class="comment-details">
                        <div class="comment-author">
                          [[item1.journalUserName]]
                        </div>
                        <div class="paper-font-caption comment-date">
                          [[timeSince(item1.date)]]
                        </div>
                      </div>
                      <div class="comment-msg">
                        [[item1.comment]]
                      </div>
                    </div>
                  </div>
                </template>
                <div class="comment-area">
                  <div class="card-avatar comment-avatar" style$="[[_profilePhoto(user.photoURL)]]"></div>
                  <div class="comment-input">
                    <paper-textarea no-label-float rows="1" multiple label="Leave a comment..." type="text" id="input[[item.dailyThoughtID]]" name="input[[item.dailyThoughtID]]" auto-validate>
                    </paper-textarea> 
                  </div>
                  <div class="comment-btn">
                    <iron-icon icon="app:send" on-tap="_saveComment" id="btn[[item.dailyThoughtID]]" data="[[item.dailyThoughtID]]"></iron-icon>
                  </div>
                </div>
                  
              </div>
              <div page-comrate="page-rate[[item.dailyThoughtID]]" id="page-rate[[item.dailyThoughtID]]" class="pageComments">
                  <template is="dom-repeat" items="{{_toArray(item.ratings)}}" as="item1">
                      <div class="comments-box">
                        <div class="card-avatar comment-avatar" style$="[[_profilePhoto(item1.photoURL)]]"></div>
                        <div class="comments-info">
                          <div class="comment-details">
                            <div class="comment-author">
                              [[item1.journalUserName]]
                            </div>
                            <div class="paper-font-caption comment-date">
                              [[timeSince(item1.date)]]
                            </div>
                          </div>
                          <div class="comment-msg">
                            <l2t-paper-rating rating="[[item1.rating]]" readonly class="rate-color rated-icons"></l2t-paper-rating>
                          </div>
                        </div>
                      </div>
                    </template>
                    <div class="comment-area">
                      <div class="card-avatar comment-avatar" style$="[[_profilePhoto(user.photoURL)]]"></div>
                      <div class="comment-input">
                        <p class="paper-font-caption">Leave a rating...</p>
                        <l2t-paper-rating id="rateThought[[item.dailyThoughtID]]" rating="2" class="rate-color-post"></l2t-paper-rating>
                      </div>
                      <div class="comment-btn">
                        <iron-icon icon="app:send" on-tap="_saveRateValue" id="rat[[item.dailyThoughtID]]" data="[[item.dailyThoughtID]]"></iron-icon>
                      </div>
                    </div>
              </div>
            </iron-pages>
        </div>
      </div>
    </main>
    <div class="container">
      <paper-dialog id="deleteDialog">
        <paper-icon-button icon="myicons:cancel" class="red"></paper-icon-button><h2 id="discardTitle">Discard Thought?</h2>
        <hr>
          <p id="thoughtTitle" class="thought-rate-title"></p>
          <p id="thoughtAuthor" class="thought-rate-title paper-font-caption"></p>
        <hr>
        <div class="buttons">
          <paper-button dialog-dismiss>CANCEL</paper-button>
          <paper-button on-tap="deleteThought">DISCARD</paper-button>
        </div>
      </paper-dialog>
    </div>
    <div id="snackbar"></div>
  </template>

  <script>
    class PostThought extends Polymer.Element {
      static get is() { return 'post-thought'; }
      static get properties() {
        return {
          user: {
            type: Object
          },
          _companyid: String,
          item: {
            type: Object,
            value: [],
            notify: true
          },
          _selected: String,
          _selectedComRate: String,
          _selectedComRates: {
            type: Number,
            value: 0
          },
          opened: {
            type: Boolean,
            reflectToAttribute: true,
            value: true
          },
          lastSelected: {
            type: String,
            value: ''
          },
          openedComRate: {
            type: Boolean,
            reflectToAttribute: true,
            value: true
          },
          lastSelectedComRate: {
            type: String,
            value: ''
          },
          commentsData: {
            type: Object,
            observer: '_oncommentsData'
          },
          loadsrc: {
            type: String,
            value: ""
          },
        };
      }

      _myLoadElement(elementName, htmlImport) {
          // Let's remove last loaded element if exists
          this._removeElement();
          var container = Polymer.dom(this.root).querySelector('#media');
          var __companyid = this._companyid;
          var __user = this.user;
          var __loadsrc = this.loadsrc;
          let pos = window.scrollY;

          sessionStorage.setItem('pos', pos);
          
          window.scrollTo(0, 0);
          document.body.style.overflow = 'hidden';

          // Now we load it on-the-fly
          Polymer.importHref(this.resolveUrl(htmlImport), function (e) {
            // Create a new instance
            var myElement = document.createElement(elementName);
            // And add it to the container
            container.appendChild(myElement);
            // Lets set a dummy property just to show how to do it
            myElement._companyid = __companyid;
            myElement.user = __user;
            myElement.loadsrc = __loadsrc;
          });
        }
        _loadElement(){
          // var name = e.target.getAttribute('elem');
          this._myLoadElement("load-media", "load-media.html");
        }
        _removeElement () {
          var container = Polymer.dom(this.root).querySelector('#media');

          var element = container.querySelector("*");
          if (element) {
              element.parentNode.removeChild(element);
          }
        }

      _oncommentsData(){
        this.commentsData.sort(function(a, b) {
        var nameA = a.dateRegistered; // ignore upper and lowercase
        var nameB = b.dateRegistered; // ignore upper and lowercase
        if (nameA < nameB) {
          return 1;
        }
        if (nameA > nameB) {
          return -1;
        }
        return 0;
        });
          
      }
      _sortComments(obj){
        
        if(obj != undefined){
          // var modObj = obj;
          // modObj.sort();
          return Object.keys(obj).map(function(key) {
            return obj[key];
          });
        }
      }
      toggleComRate(e){
        var selectedElem = e.target.id;
        let dailyThought_ID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;

        var pages = Polymer.dom(this.root).querySelector('#page'+dailyThought_ID);
        pages.selectNext();
      }
      toggle(e){
        var a = Polymer.dom(this.root).querySelector('#'+e.target.id).data;

        var selectedElem = e.target.id;

        this.opened = Polymer.dom(this.root).querySelector('#collapse'+a).opened;
            
        var res = selectedElem.substring(0, 3);
        
        if(res == 'blu'){
          this._selected = 'page-1-'+a;
        }else if(res == 'gre'){
          this._selected = 'page-2-'+a;
        }else if(res == 'cam'){
          this._selected = 'page-3-'+a;
        }else if(res == 'red'){
          this._selected = 'page-4-'+a;
        }

        if((this.lastSelected == this._selected) && (this.opened)){
          Polymer.dom(this.root).querySelector('#collapse'+a).toggle();
        }

        if((this.lastSelected == this._selected) && (!this.opened)){
          Polymer.dom(this.root).querySelector('#collapse'+a).toggle();
        }

        if((this.lastSelected != this._selected) && (!this.opened)){
          Polymer.dom(this.root).querySelector('#collapse'+a).toggle();
        }

        this.lastSelected = this._selected;

      }
      _editThought(e){
        // Edit Thought
        this.addedit = 1;
        let editThoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;

        let filteredArray = this.findObjectByKey(this.thoughtsData, "dailyThoughtID", editThoughtID);

        let editThoughtStr = JSON.stringify(filteredArray);
        
        sessionStorage.setItem("addedit", this.addedit);
        sessionStorage.setItem("editThoughtID", editThoughtID);
        sessionStorage.setItem("editThoughtStr", editThoughtStr);

      }
      _getVideoName(storageName){
        let strName = '';
        strName = storageName.slice(storageName.lastIndexOf('/')+1);
        strName = strName.replace(new RegExp('_', 'g'), ' ');
        return strName;
      }
      _videoClick(e){      
        var videoClicked = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        
        var youtubeID = this.getYoutubeID(videoClicked);

        var src = "https://www.youtube.com/embed/"+youtubeID;

        // var videoPlayer = Polymer.dom(this.root).querySelector('#videoPlayer');
        // videoPlayer.src = src;
        // this.$.videoDialog.open();

        this.loadsrc = src;
        this._loadElement();
      }
      _dialogImgOpen(e){
        var a = Polymer.dom(this.root).querySelector('#'+e.target.id).src;
        var b = this.$.showImage;
        b.src = a;
        this.$.imgDialog.open();
      }
      _getPodcastName(storageName){
        let strName = '';
        strName = storageName.slice(storageName.lastIndexOf('/')+1);
        strName = strName.replace(new RegExp('_', 'g'), ' ');
        return strName;
      }
      _saveComment(e){
        let dailyThought_ID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        let comment = Polymer.dom(this.root).querySelector('#input'+dailyThought_ID).value;

        // Validate thought
        if ((comment == undefined) || (comment.trim() == "")){
          this.showSnackBar("Please enter a comment!");
          return;
        }

        var journalUserID = this.user.userID;
        var journalUserName = this.user.firstName+" "+this.user.lastName;

        var companyID = this.user.companyID;
        var companyName = this.user.companyName;

        var photoURL = "";

        if(this.user.photoURL != undefined || this.user.photoURL != ""){
          photoURL = this.user.photoURL;
        }else{
          photoURL = "";
        }

        if(photoURL == undefined){
          photoURL = "";
        }

        let date = Date.now();
        let stringDate = this.formatDate(date);
        let stringCommentDate = this.formatRateTime(date);

        // Get a reference to the database service
        var database = firebase.database();

        var newCommentKey = database.ref().child('comments').push().key;

        if(comment == undefined){
          comment = "";
        }

        // fix data
        // dailyThoughts
        var data = {
          companyID: companyID,
          companyName: companyName,
          journalUserID: journalUserID,
          journalUserName: journalUserName,
          photoURL: photoURL,
          comment: comment,
          dailyThoughtID: dailyThought_ID,
          date: date,
          commentID: newCommentKey,
          stringDate: stringDate,
          stringCommentDate: stringCommentDate
        }

        // Write the new comments data
        console.log(JSON.stringify("Data: "+data));
        var updates = {};
        updates['/comments/' + newCommentKey] = data;
        database.ref().update(updates);

        // Write the new comments on thoughts data
        var newTypeCommentKey = database.ref().child('/dailyThoughts/' + dailyThought_ID +'/comments').push().key;
        var commentUpdates = {};
        commentUpdates['/dailyThoughts/'+dailyThought_ID+'/comments/'+newTypeCommentKey] = data;
        database.ref().update(commentUpdates);

        Polymer.dom(this.root).querySelector('#input'+dailyThought_ID).value = "";
      }
      _saveRateValue(e){
        let dailyThought_ID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        let rating = Polymer.dom(this.root).querySelector('#rateThought'+dailyThought_ID).rating;
        // let rating = this.$.rateThought.rating;
        // let comment = this.$.rateComment.value;
        let comment = "";

        var journalUserID = this.user.userID;
        var journalUserName = this.user.firstName+" "+this.user.lastName;

        var companyID = this.user.companyID;
        var companyName = this.user.companyName;

        var photoURL = "";

        if(this.user.photoURL != undefined || this.user.photoURL != ""){
          photoURL = this.user.photoURL;
        }else{
          photoURL = "";
        }

        if(photoURL == undefined){
          photoURL = "";
        }

        let date = Date.now();
        let stringDate = this.formatDate(date);
        let stringRateDate = this.formatRateTime(date);
        // let stringDate = new Date(date).toUTCString();

        // Get a reference to the database service
        var database = firebase.database();

        var newRateKey = database.ref().child('ratings').push().key;

        if(comment == undefined){
          comment = "";
        }

        // fix data
        // dailyThoughts
        var data = {
          companyID: companyID,
          companyName: companyName,
          journalUserID: journalUserID,
          journalUserName: journalUserName,
          photoURL: photoURL,
          comment: comment,
          dailyThoughtID: dailyThought_ID,
          date: date,
          rating: rating,
          ratingID: newRateKey,
          stringDate: stringDate,
          stringRateDate: stringRateDate
        }

        // Write the new rating data
        var updates = {};
        updates['/ratings/' + newRateKey] = data;
        database.ref().update(updates);

        // Write the new rating on thoughts data
        var newTypeRateKey = database.ref().child('/dailyThoughts/' + dailyThought_ID +'/ratings').push().key;
        var rateUpdates = {};
        rateUpdates['/dailyThoughts/' + dailyThought_ID +'/ratings/'+newTypeRateKey] = data;
        database.ref().update(rateUpdates);

        Polymer.dom(this.root).querySelector('#rateThought'+dailyThought_ID).rating = 2;
        // this.$.rateComment.value = "";

        this.showSnackBar("Rating posted successfully!");
      }
      _toArray(obj) {
        if(obj != undefined){
          return Object.keys(obj).map(function(key) {
            var retObj = {};
            retObj = obj[key];
            // assign object id to lpUID
            retObj['lpUID'] = key;
            return retObj;
            // return obj[key];
        });
        }
      }
      _objLen(obj) {
        let len = 0;
        if(obj != undefined){
          len = Object.keys(obj).length;
        }
        return len;
      }

      formatDate(date) {
        var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hours = '' + d.getHours(),
        minutes = '' + d.getMinutes(),
        seconds = '' + d.getSeconds(),
        milliseconds = '' + d.getMilliseconds();

        var today = new Date(),
        thisYear = today.getFullYear();

        // get week day name Sunday - Saturday
        var dayName = this.getDayMonthStr(d.getDay(), "day", true);

        // get month name
        var monthName = this.getDayMonthStr(d.getMonth(), "month", true);

        // add preceding zeros where needed
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        if (hours.length < 2) hours = '0' + hours;
        if (minutes.length < 2) minutes = '0' + minutes;
        if (seconds.length < 2) seconds = '0' + seconds;
        if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

        // format thoughts date
        // Monday, 04 December 2017 14:21:56
        var thoughtDate = dayName+", "+day+" "+monthName+" "+year+" "+hours+":"+minutes+":"+seconds;

        return thoughtDate;
        // return [year, month, day].join('-');
      }
      formatRateTime(date) {
        var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hours = d.getHours() > 12 ? d.getHours() - 12 : d.getHours(),
        am_pm = d.getHours() >= 12 ? "PM" : "AM",
        minutes = '' + d.getMinutes(),
        seconds = '' + d.getSeconds(),
        milliseconds = '' + d.getMilliseconds();

        var today = new Date(),
        thisYear = today.getFullYear();

        // get week day name Sunday - Saturday
        var dayName = this.getDayMonthStr(d.getDay(), "day", true);

        // get month name
        var monthName = this.getDayMonthStr(d.getMonth(), "month", false);

        // add preceding zeros where needed
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        // if (hours.length < 2) hours = '0' + hours;
        hours = hours < 10 ? "0" + hours : hours;
        if (minutes.length < 2) minutes = '0' + minutes;
        if (seconds.length < 2) seconds = '0' + seconds;
        if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

        // format thoughts date
        // 04 Dec 02:21:PM
        var thoughtDate = day+" "+monthName+" "+hours+":"+minutes+":"+am_pm;

        return thoughtDate;
        // return [year, month, day].join('-');
      }
      timeSince(date) {
        if (typeof date !== 'object') {
          date = new Date(date);
        }

        var seconds = Math.floor((new Date() - date) / 1000);
        var intervalType;

        var interval = Math.floor(seconds / 31536000);
        if (interval >= 1) {
          intervalType = 'year';
        } else {
          interval = Math.floor(seconds / 2592000);
          if (interval >= 1) {
            intervalType = 'month';
          } else {
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) {
              intervalType = 'day';
            } else {
              interval = Math.floor(seconds / 3600);
              if (interval >= 1) {
                intervalType = "hour";
              } else {
                interval = Math.floor(seconds / 60);
                if (interval >= 1) {
                  intervalType = "minute";
                } else {
                  interval = seconds;
                  intervalType = "second";
                }
              }
            }
          }
        }

        if (interval > 1 || interval === 0) {
          intervalType += 's';
        }

        return interval + ' ' + intervalType+' ago';
      };
      getDayMonthStr(val, dateParam, long){
        // days
        var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        var daysShort = ["Sun","Mon","Tue","Wed","Thur","Fri","Sat"];

        // Months
        var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September","October", "November", "December"];
        var monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sep","Oct", "Nov", "Dec"];

        if(dateParam == "day" && long == true){
          // return day in long format
          return days[val];
        }
        else if(dateParam == "day" && long == false){
          // return days in short
          return daysShort[val];
        }
        if(dateParam == "month" && long == true){
          // return month in long format
          return monthNames[val];
        }
        else if(dateParam == "month" && long == false){
          // return month in short
          return monthNamesShort[val];
        }
        
      }
      _openPLDP(e){
        var thoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        sessionStorage.setItem("PLDP_ThoughtAdd", thoughtID);
        this.$.pldpDialog.open();
      }
      getYoutubeID(youtubeURL) {
          var str = youtubeURL;
          var n = str.indexOf("=");
          var x = str.indexOf("&");
          var res = "";
      
          if(n == -1){
            n = str.indexOf("youtu.be");
            if(x == -1) res = str.substring(n+9);
            else res = str.substring(n+9, x);
          }else{
            if(x == -1) res = str.substring(n+1);
            else res = str.substring(n+1, x);
          }
          
          return res;
      }
      getYoutubeThumbnail(youtubeURL) {
        var res = this.getYoutubeID(youtubeURL);
        return "https://img.youtube.com/vi/"+res+"/0.jpg";
      }
      findObjectByKey(array, key, value) {
          for (var i = 0; i < array.length; i++) {
              if (array[i][key] === value) {
                  return array[i];
              }
          }
          return null;
      }
      closePLDPDialog(){
        this._addToPLDP();
        sessionStorage.removeItem("PLDP_ThoughtAdd");
        this.$.pldpDialog.close();
      }
      _addToPLDP(){
        let PLDP_ThoughtAdd = sessionStorage.getItem("PLDP_ThoughtAdd");

        let filteredArray = this.findObjectByKey(this.thoughtsData, "dailyThoughtID", PLDP_ThoughtAdd);

        // remove the key
        delete filteredArray['$key'];

        // add PLDP user to the thought object
        filteredArray.PLDPUserID = this.user.userID;
        filteredArray.PLDPUserName = this.user.firstName+" "+this.user.lastName;

        // instantiate db
        let database = firebase.database();

        // create new record
        let newThought = database.ref().child('/myPLDP/dailyThoughts').push().key;

        // delete the thought if already exists
        let ref = database.ref('myPLDP/dailyThoughts');
        ref.orderByChild('dailyThoughtID').equalTo(PLDP_ThoughtAdd)
            .once('value').then(function(snapshot) {
                snapshot.forEach(function(childSnapshot) {
                if(newThought === childSnapshot.key){
                  console.log("Got the new ID");
                }else{
                  // remove each old child
                  ref.child(childSnapshot.key).remove();
                }
            });
        });
        
        let updates = {};
        updates['/myPLDP/dailyThoughts/' + newThought] = filteredArray;
        database.ref().update(updates);
      }
      _profilePhoto(photo){
        let photo_url = "background-image: url('../images/default-user.png');";

        if(photo == undefined){
          photo_url = "background-image: url('../images/default-user.png');";
        }else if(photo == ""){
          photo_url = "background-image: url('../images/default-user.png');";
        }else{
          photo_url = 'background-image: url('+photo+');';
        }

        return photo_url;
      }
      isEqual(a, b) {
        return a === b;
      }
      _photo(photos){
        let photo_url = "background-image: url('../data/land.jpg');";

        for (item in photos) { 
          photo_url = 'background-image: url('+photos[item].url+');';
        }

        return photo_url;
      }

      _deleteThoughtImg(e){
        var thoughtPhotoID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        var deldailyThoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).dataval;
            
        sessionStorage.setItem("thoughtPhotoID", thoughtPhotoID);
        sessionStorage.setItem("deldailyThoughtID", deldailyThoughtID);
        sessionStorage.setItem("deleteType", "photo");

        this.$.discardTitle.innerHTML = "Discard Photo";
        this.$.thoughtTitle.innerHTML = 'Delete selected photo?';
        this.$.thoughtAuthor.innerHTML = '';

        this.$.deleteDialog.open();
      }
      _deleteThoughtURL(e){
        var thoughtURLID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        var deldailyThoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).dataval;
            
        sessionStorage.setItem("thoughtURLID", thoughtURLID);
        sessionStorage.setItem("deldailyThoughtID", deldailyThoughtID);
        sessionStorage.setItem("deleteType", "url");

        this.$.discardTitle.innerHTML = "Discard Article Link";
        this.$.thoughtTitle.innerHTML = 'Delete selected article link?';
        this.$.thoughtAuthor.innerHTML = '';

        this.$.deleteDialog.open();
      }
      _deleteThoughtPodcast(e){
        var thoughtPodcastID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        var deldailyThoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).dataval;
        var podcastID = Polymer.dom(this.root).querySelector('#'+e.target.id).datapod;
            
        sessionStorage.setItem("thoughtPodcastID", thoughtPodcastID);
        sessionStorage.setItem("podcastID", podcastID);
        sessionStorage.setItem("deldailyThoughtID", deldailyThoughtID);
        sessionStorage.setItem("deleteType", "podcast");

        this.$.discardTitle.innerHTML = "Discard Podcast Link";
        this.$.thoughtTitle.innerHTML = 'Delete selected podcast link?';
        this.$.thoughtAuthor.innerHTML = '';

        this.$.deleteDialog.open();
      }
      _deleteThoughtVideo(e){
        var thoughtVideoID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
        var deldailyThoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).dataval;
        var videoID = Polymer.dom(this.root).querySelector('#'+e.target.id).datavid;
            
        sessionStorage.setItem("thoughtVideoID", thoughtVideoID);
        sessionStorage.setItem("videoID", videoID);
        sessionStorage.setItem("deldailyThoughtID", deldailyThoughtID);
        sessionStorage.setItem("deleteType", "video");

        this.$.discardTitle.innerHTML = "Discard Video Link";
        this.$.thoughtTitle.innerHTML = 'Delete selected video link?';
        this.$.thoughtAuthor.innerHTML = '';

        this.$.deleteDialog.open();
      }
      _deleteThought(e){
        var dailyThoughtID = Polymer.dom(this.root).querySelector('#'+e.target.id).data;
            
        sessionStorage.setItem("deldailyThoughtID", dailyThoughtID);
        sessionStorage.setItem("deleteType", "thought");

        var filteredArray = this.findObjectByKey(this.thoughtsData, "dailyThoughtID", dailyThoughtID);

        this.$.thoughtTitle.innerHTML = '"'+filteredArray.title+'"';
        this.$.thoughtAuthor.innerHTML = filteredArray.subtitle;

        this.$.deleteDialog.open();
      }
      deleteThought(){
        var deleteType = sessionStorage.getItem("deleteType");
        var dailyThoughtID = sessionStorage.getItem("deldailyThoughtID");

        // delete Thought
        if(deleteType == "thought"){
          // Get a reference to the database service
          var database = firebase.database();

          // delete thoughts
          database.ref('dailyThoughts/'+ dailyThoughtID).remove();

          this.showSnackBar("Thought deleted successfully!");

          sessionStorage.removeItem("deldailyThoughtID");
        }
        else if(deleteType == "photo"){
          var thoughtPhotoID = sessionStorage.getItem("thoughtPhotoID");
          // Get a reference to the database service
          var database = firebase.database();

          // delete thoughts
          database.ref('dailyThoughts/'+dailyThoughtID+'/photos/'+ thoughtPhotoID).remove();

          this.showSnackBar("Photo deleted successfully!");

          sessionStorage.removeItem("thoughtPhotoID");
          sessionStorage.removeItem("deldailyThoughtID");
        }
        else if(deleteType == "url"){
          var thoughtURLID = sessionStorage.getItem("thoughtURLID");
          // Get a reference to the database service
          var database = firebase.database();

          // delete url
          database.ref('dailyThoughts/'+dailyThoughtID+'/urls/'+ thoughtURLID).remove();

          this.showSnackBar("Article deleted successfully!");

          sessionStorage.removeItem("thoughtURLID");
          sessionStorage.removeItem("deldailyThoughtID");
        }
        else if(deleteType == "podcast"){
          var thoughtPodcastID = sessionStorage.getItem("thoughtPodcastID");
          var podcastID = sessionStorage.getItem("podcastID");
          // Get a reference to the database service
          var database = firebase.database();

          // delete podcast from thought
          database.ref('dailyThoughts/'+dailyThoughtID+'/podcasts/'+ thoughtPodcastID).remove();

          // delete podcast
          database.ref('podcasts/'+ podcastID).remove();

          this.showSnackBar("Podcast deleted successfully!");

          sessionStorage.removeItem("thoughtPodcastID");
          sessionStorage.removeItem("podcastID");
          sessionStorage.removeItem("deldailyThoughtID");
        }
        else if(deleteType == "video"){
          var thoughtVideoID = sessionStorage.getItem("thoughtVideoID");
          var videoID = sessionStorage.getItem("videoID");
          // Get a reference to the database service
          var database = firebase.database();

          // delete podcast from thought
          database.ref('dailyThoughts/'+dailyThoughtID+'/videos/'+ thoughtVideoID).remove();

          // delete podcast
          database.ref('videos/'+ videoID).remove();

          this.showSnackBar("Video deleted successfully!");

          sessionStorage.removeItem("thoughtVideoID");
          sessionStorage.removeItem("videoID");
          sessionStorage.removeItem("deldailyThoughtID");
        }
        
        sessionStorage.removeItem("deleteType");
        this.$.deleteDialog.close();
      }
      showSnackBar(msg){
        var x = this.$.snackbar;

        x.innerHTML = msg;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }
    }

    window.customElements.define(PostThought.is, PostThought);
  </script>
</dom-module>
