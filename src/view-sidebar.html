<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="manifest" href="/manifest.json">

<link rel="import" href="../bower_components/polymer/polymer-element.html">

<link rel="import" href="../bower_components/paper-button/paper-button.html">

<!-- Firebase Auth -->
<link rel="import" href="../bower_components/polymerfire/firebase-auth.html">

<!-- Firebase Query -->
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-database-behavior.html">

<link rel="import" href="app-icons.html">
<link rel="import" href="shared-styles.html">

<dom-module id="view-sidebar">
  <template>
    <template is="dom-if" if="[[user.companyID]]">
        <firebase-query
            id="categories"
            path="/categories"
            order-by-child="companyID"
            equal-to="[[user.companyID]]"
            data="{{categoriesData}}">
        </firebase-query>

        <firebase-query
            id="qrycomments"
            path="/comments"
            order-by-child="companyID"
            equal-to="[[user.companyID]]"
            limit-to-last="5"
            data="{{commentsData}}">
        </firebase-query>
    </template>

    <style include="shared-styles">
        :host {
            /* Label and underline color when the input is focused */
          --paper-input-container-focus-color: #fff;

          /* Label and underline color when the input is invalid */
          --paper-input-container-invalid-color: red;

          /* Input foreground color */
          --paper-input-container-label:{
            font-size: 12px;
            margin-bottom: 4px;
            color: #757575;
          };
          --paper-input-container-input-focus:{
            font-size: 14px;
            margin-bottom: 4px;
            color: var(--app-primary-text);
          };
        }
        .card-container{
          border: 1px solid #e6e6e6;
          margin-top: 10px;
          margin-bottom: 30px;
          background-color: #fff;
        }
        .about-pldp{
            white-space: pre-wrap;
            text-indent: 0%;
            padding: 0 16px;
            font-size: 10pt;
        }
        .read-more{
            color: var(--app-primary-color);
        }
        .header{
            padding: 0 16px;
            /* color: var(--app-primary-color); */
        }
        paper-button.indigo {
            background-color: var(--app-status-color);
            color: var(--app-secondary-text);
            padding-top: 10px;
            margin: 0 auto;
            min-width: 96px;
            font-family: 'Roboto', 'Noto', sans-serif;
            font-weight: normal;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }
        .comments-box{
          display: -webkit-flex;
          display: flex;
          padding: 10px 16px;
        }
        .comments-info{
          display: -webkit-flex;
          display: flex;
          flex-direction: column;
          max-width: 80%;
        }
        .comment-details{
          display: -webkit-flex;
          display: flex;
          flex-direction: row;
          margin-bottom: 6px;
        }
        .comment-author{
          margin-right: 16px;
          color: var(--app-primary-color);
        }
        .comment-date{
          color: #9e9e9e !important;
        }
        .comment-msg{
         color: var(--app-primary-text);
        }
        .get-started{
          padding: 16px;
        }
    </style>
    <section>
        <div class="card-container fadeInUp">
          <div class="about-pldp">
              <h3 class="header">About PLDP (Personal Leadership Development Plan)</h3>
              This article explains why your Personal Leadership Development Plan (PLDP) is presented in the form of Motivation, Direction and Structure.<br>
              The PLDP will become part of your life as you take ownership of your own leadership development fitness and <a href="about-pldp" class="add-thought-link"><span class="read-more">Read more...</span></a>
          </div>
          <div class="get-started">
            <a id="backBtn" href="my-pldp" class="add-thought-link">
                <paper-button raised class="add-thought-link indigo">GET STARTED</paper-button>
            </a>
          </div>
          
        </div>
        <div class="card-container fadeInUp">
            <div>
                <h3 class="header">Popular Topics</h3>
                <ol>
                    <template is="dom-repeat" items="[[categoriesData]]" as="item">
                    <li>[[item.categoryName]]</li>
                </template>
                </ol>
                
            </div>
        </div>
        <div class="card-container fadeInUp">
            <div>
                <h3 class="header">Recent Comments</h3>
                <template is="dom-repeat" items="[[commentsData]]" as="item1">
                <div class="comments-box">
                    <div class="card-avatar comment-avatar" style$="[[_profilePhoto(item1.photoURL)]]"></div>
                    <div class="comments-info">
                    <div class="comment-details">
                        <div class="comment-author">
                        [[item1.journalUserName]]
                        </div>
                        <div class="paper-font-caption comment-date">
                        [[timeSince(item1.date)]]
                        </div>
                    </div>
                    <div class="comment-msg">
                        [[item1.comment]]
                    </div>
                    </div>
                </div>
                </template>
                
            </div>
        </div>
    </section>
    <div id="snackbar"></div>
  </template>

  <script>
    class ViewSidebar extends Polymer.Element {
      static get is() { return 'view-sidebar'; }
      static get properties() {
        return {
          user: {
            type: Object
          },
          _companyid: String,
          categoriesData: {
            type: Object,
            observer: '_oncategoriesDataReceived'
          },
          commentsData: {
            type: Object,
            observer: '_oncommentsDataReceived'
          }
        };
      }
      connectedCallback() { 
        super.connectedCallback();
        
      }
      _oncategoriesDataReceived(newData, oldData){
        // this.thoughtsData.sort(function(a, b) {
        // var nameA = a.dateRegistered; // ignore upper and lowercase
        // var nameB = b.dateRegistered; // ignore upper and lowercase
        // if (nameA < nameB) {
        //   return 1;
        // }
        // if (nameA > nameB) {
        //   return -1;
        // }
        // return 0;
        // });
          
      }
      _oncommentsDataReceived(newData, oldData){
        this.commentsData.sort(function(a, b) {
        var nameA = a.date; // ignore upper and lowercase
        var nameB = b.date; // ignore upper and lowercase
        if (nameA < nameB) {
          return 1;
        }
        if (nameA > nameB) {
          return -1;
        }
        return 0;
        });
          
      }
      _toArray(obj) {
        if(obj != undefined){
          return Object.keys(obj).map(function(key) {
            var retObj = {};
            retObj = obj[key];
            // assign object id to lpUID
            retObj['lpUID'] = key;
            return retObj;
            // return obj[key];
        });
        }
      }
      _objLen(obj) {
        let len = 0;
        if(obj != undefined){
          len = Object.keys(obj).length;
        }
        return len;
      }
      _photo(photos){
        let photo_url = "background-image: url('../data/land.jpg');";

        for (var item in photos) { 
          photo_url = "background-image: url('"+photos[item].url+"');";
        }

        return photo_url;
      }
      _profilePhoto(photo){
        let photo_url = "background-image: url('../images/profile/default-user.png');";

        if(photo == undefined){
          photo_url = "background-image: url('../images/profile/default-user.png');";
        }else if(photo == ""){
          photo_url = "background-image: url('../images/profile/default-user.png');";
        }else{
          photo_url = 'background-image: url('+photo+');';
        }

        return photo_url;
      }
      formatDate(date) {
        var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hours = '' + d.getHours(),
        minutes = '' + d.getMinutes(),
        seconds = '' + d.getSeconds(),
        milliseconds = '' + d.getMilliseconds();

        var today = new Date(),
        thisYear = today.getFullYear();

        // get week day name Sunday - Saturday
        var dayName = this.getDayMonthStr(d.getDay(), "day", true);

        // get month name
        var monthName = this.getDayMonthStr(d.getMonth(), "month", true);

        // add preceding zeros where needed
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        if (hours.length < 2) hours = '0' + hours;
        if (minutes.length < 2) minutes = '0' + minutes;
        if (seconds.length < 2) seconds = '0' + seconds;
        if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

        // format thoughts date
        // Monday, 04 December 2017 14:21:56
        var thoughtDate = dayName+", "+day+" "+monthName+" "+year+" "+hours+":"+minutes+":"+seconds;

        return thoughtDate;
        // return [year, month, day].join('-');
      }
      formatRateTime(date) {
        var d = new Date(date),
        month = '' + (d.getMonth() + 1),
        day = '' + d.getDate(),
        year = d.getFullYear(),
        hours = d.getHours() > 12 ? d.getHours() - 12 : d.getHours(),
        am_pm = d.getHours() >= 12 ? "PM" : "AM",
        minutes = '' + d.getMinutes(),
        seconds = '' + d.getSeconds(),
        milliseconds = '' + d.getMilliseconds();

        var today = new Date(),
        thisYear = today.getFullYear();

        // get week day name Sunday - Saturday
        var dayName = this.getDayMonthStr(d.getDay(), "day", true);

        // get month name
        var monthName = this.getDayMonthStr(d.getMonth(), "month", false);

        // add preceding zeros where needed
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        // if (hours.length < 2) hours = '0' + hours;
        hours = hours < 10 ? "0" + hours : hours;
        if (minutes.length < 2) minutes = '0' + minutes;
        if (seconds.length < 2) seconds = '0' + seconds;
        if (milliseconds.length < 2) milliseconds = '0' + milliseconds;

        // format thoughts date
        // 04 Dec 02:21:PM
        var thoughtDate = day+" "+monthName+" "+hours+":"+minutes+":"+am_pm;

        return thoughtDate;
        // return [year, month, day].join('-');
      }
      timeSince(date) {
        if (typeof date !== 'object') {
          date = new Date(date);
        }

        var seconds = Math.floor((new Date() - date) / 1000);
        var intervalType;

        var interval = Math.floor(seconds / 31536000);
        if (interval >= 1) {
          intervalType = 'year';
        } else {
          interval = Math.floor(seconds / 2592000);
          if (interval >= 1) {
            intervalType = 'month';
          } else {
            interval = Math.floor(seconds / 86400);
            if (interval >= 1) {
              intervalType = 'day';
            } else {
              interval = Math.floor(seconds / 3600);
              if (interval >= 1) {
                intervalType = "hour";
              } else {
                interval = Math.floor(seconds / 60);
                if (interval >= 1) {
                  intervalType = "minute";
                } else {
                  interval = seconds;
                  intervalType = "second";
                }
              }
            }
          }
        }

        if (interval > 1 || interval === 0) {
          intervalType += 's';
        }

        return interval + ' ' + intervalType+' ago';
      };
      getDayMonthStr(val, dateParam, long){
        // days
        var days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
        var daysShort = ["Sun","Mon","Tue","Wed","Thur","Fri","Sat"];

        // Months
        var monthNames = ["January", "February", "March", "April", "May", "June","July", "August", "September","October", "November", "December"];
        var monthNamesShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun","Jul", "Aug", "Sep","Oct", "Nov", "Dec"];

        if(dateParam == "day" && long == true){
          // return day in long format
          return days[val];
        }
        else if(dateParam == "day" && long == false){
          // return days in short
          return daysShort[val];
        }
        if(dateParam == "month" && long == true){
          // return month in long format
          return monthNames[val];
        }
        else if(dateParam == "month" && long == false){
          // return month in short
          return monthNamesShort[val];
        }
        
      }
      getYoutubeID(youtubeURL) {
          var str = youtubeURL;
          var n = str.indexOf("=");
          var x = str.indexOf("&");
          var res = "";
      
          if(n == -1){
            n = str.indexOf("youtu.be");
            if(x == -1) res = str.substring(n+9);
            else res = str.substring(n+9, x);
          }else{
            if(x == -1) res = str.substring(n+1);
            else res = str.substring(n+1, x);
          }
          
          return res;
      }
      getYoutubeThumbnail(youtubeURL) {
        var res = this.getYoutubeID(youtubeURL);
        return "https://img.youtube.com/vi/"+res+"/0.jpg";
      }
      findObjectByKey(array, key, value) {
          for (var i = 0; i < array.length; i++) {
              if (array[i][key] === value) {
                  return array[i];
              }
          }
          return null;
      }
      isEqual(a, b) {
        return a === b;
      }
      showSnackBar(msg){
        var x = this.$.snackbar;

        x.innerHTML = msg;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
      }
    }

    window.customElements.define(ViewSidebar.is, ViewSidebar);
  </script>
</dom-module>
